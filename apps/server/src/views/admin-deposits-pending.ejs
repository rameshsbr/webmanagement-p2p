<% layout('admin/layout') -%>

<% const q2 = Object.assign({}, query, { status:'PENDING,SUBMITTED' }); %>
<%- include('partials/filters-bar', { query: q2, type: 'DEPOSIT', exportBase: 'deposits' }) %>
<%- include('partials/column-settings', { key: 'admin.columns.deposits' }) %>

<div class="table-wrap">
  <table class="table">
    <thead>
      <tr>
        <th data-col="txnId">TRANSACTION ID</th>
        <th data-col="userId">USER ID</th>
        <th data-col="currency">CURRENCY</th>
        <th data-col="amount">AMOUNT</th>
        <th data-col="status">STATUS</th>
        <th data-col="bank">BANK NAME</th>
        <th data-col="created">DATE OF CREATION</th>
        <th data-col="updated">TIME OF PROCESSING</th>
        <th data-col="userInfo">USER INFO</th>
        <th data-col="actions">ACTIONS</th>
      </tr>
    </thead>
    <tbody>
      <% if (!table.items.length) { %>
        <tr><td colspan="10" style="text-align:center;color:var(--ink-dim)">No data</td></tr>
      <% } %>
      <% table.items.forEach(r=>{ %>
        <tr>
          <td data-col="txnId"><div><%= r.referenceCode %></div><small style="color:var(--ink-dim)"><%= r.id %></small></td>
          <td data-col="userId"><%= r.userId %></td>
          <td data-col="currency"><%= r.currency %></td>
          <td data-col="amount"><%= r.amountCents %></td>
          <td data-col="status">
            <% if (r.status === 'SUBMITTED') { %>
              <span class="badge">Submitted</span>
            <% } else { %>
              <span class="badge warn">Pending</span>
            <% } %>
          </td>
          <td data-col="bank"><%= r.bankAccount?.bankName || '-' %></td>
          <td data-col="created"><%= r.createdAt.toISOString() %></td>
          <td data-col="updated"><%= r.updatedAt.toISOString() %></td>
          <td data-col="userInfo" style="max-width:280px">
            <div><b>Email:</b> <%= r.user?.email || '-' %></div>
            <div><b>Phone:</b> <%= r.user?.phone || '-' %></div>
            <% if (r.receiptFile) { %><div><a href="<%= r.receiptFile.path %>" class="btn small" target="_blank">Receipt</a></div><% } %>
          </td>
          <td data-col="actions" class="actions">
            <button
              class="btn small primary"
              type="button"
              data-admin-action="approve"
              data-id="<%= r.id %>"
              data-reference="<%= r.referenceCode %>"
              data-amount="<%= r.amountCents %>"
              data-currency="<%= r.currency %>"
            >Approve</button>
            <button
              class="btn small danger"
              type="button"
              data-admin-action="reject"
              data-id="<%= r.id %>"
              data-reference="<%= r.referenceCode %>"
              data-amount="<%= r.amountCents %>"
              data-currency="<%= r.currency %>"
            >Reject</button>
          </td>
        </tr>
      <% }) %>
    </tbody>
  </table>
</div>

<div class="modal-backdrop" data-modal-root hidden>
  <div class="modal-dialog" role="dialog" aria-modal="true">
    <form method="post" data-modal-form>
      <h2 class="modal-title" data-modal-title>Confirm action</h2>
      <p class="modal-ref" data-modal-reference></p>
      <p class="modal-note" data-modal-note></p>

      <div class="form-field" data-modal-amount-wrap>
        <label for="modal-amount">Amount (in cents)</label>
        <input type="number" inputmode="numeric" min="1" step="1" id="modal-amount" name="amountCents" data-modal-amount />
      </div>

      <div class="form-field">
        <label for="modal-comment" data-modal-comment-label>Comment</label>
        <textarea id="modal-comment" rows="3" data-modal-comment></textarea>
      </div>

      <input type="hidden" name="returnTo" value="<%= returnTo %>" data-modal-return />

      <div class="modal-error" data-modal-error role="alert"></div>

      <div class="modal-actions">
        <button type="button" class="btn" data-modal-cancel>Cancel</button>
        <button type="submit" class="btn primary" data-modal-submit>Confirm</button>
      </div>
    </form>
  </div>
</div>
