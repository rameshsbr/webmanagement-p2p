<% layout('admin/layout') -%>

<% const q3 = Object.assign({}, query, { status:'PENDING,SUBMITTED' }); %>
<%- include('partials/filters-bar', { query: q3, type: 'WITHDRAWAL', exportBase: 'withdrawals' }) %>
<%- include('partials/column-settings', {
  key: 'admin.columns.withdrawals',
  labelMap: {
    processedAt: 'Date of withdrawal',
    processingTime: 'Time to process',
    merchant: 'Merchant',
    comment: 'Comment',
    admin: 'Admin'
  }
}) %>

<%
  let perPageOptions = [25, 50, 100, 150];
  const perPageValue = Number(table.perPage || 25);
  if (!perPageOptions.includes(perPageValue)) {
    perPageOptions = [...perPageOptions, perPageValue].sort((a, b) => a - b);
  }
  const perPageSelectId = 'perPage-admin-withdrawals-pending';
%>
<div class="table-toolbar">
  <form method="get">
    <% Object.entries(query || {}).forEach(([key, value]) => {
         if (value === undefined || value === null || value === '' || key === 'perPage' || key === 'page') return;
    %>
      <input type="hidden" name="<%= key %>" value="<%= value %>">
    <% }); %>
    <input type="hidden" name="page" value="1">
    <label for="<%= perPageSelectId %>">Rows per page</label>
    <select id="<%= perPageSelectId %>" name="perPage" onchange="this.form.submit()">
      <% perPageOptions.forEach((size) => { %>
        <option value="<%= size %>" <%= perPageValue === size ? 'selected' : '' %>><%= size %></option>
      <% }); %>
    </select>
  </form>
</div>

<div class="table-wrap" data-auto-refresh="pending-withdrawals" data-return-to="<%= returnTo || '' %>">
  <table class="table" data-withdraw-actions>
    <thead>
      <tr>
        <th data-col="txnId">TRANSACTION ID</th>
        <th data-col="userId">USER ID</th>
        <th data-col="merchant">MERCHANT</th>
        <th data-col="currency">CURRENCY</th>
        <th data-col="amount">AMOUNT</th>
        <th data-col="status">STATUS</th>
        <th data-col="bank">BANK NAME</th>
        <th data-col="created">DATE OF CREATION</th>
        <th data-col="processedAt">DATE OF WITHDRAWAL</th>
        <th data-col="processingTime">TIME TO PROCESS</th>
        <th data-col="userInfo">USER INFO</th>
        <th data-col="comment">COMMENT</th>
        <th data-col="admin">ADMIN</th>
        <th data-col="actions">ACTIONS</th>
      </tr>
    </thead>
    <tbody>
      <% const rows = []; const seenIds = new Set(); %>
      <% table.items.forEach((row) => { if (!seenIds.has(row.id)) { seenIds.add(row.id); rows.push(row); } }); %>
      <% const displayCount = rows.length; %>
      <% if (!rows.length) { %>
        <tr><td colspan="14" style="text-align:center;color:var(--ink-dim)">No data</td></tr>
      <% } %>
      <% rows.forEach(r=>{ %>
        <% const methodRaw = (r.detailsJson && r.detailsJson.method) || (r.bankAccount && r.bankAccount.method) || ''; %>
        <% const method = (methodRaw || '').toUpperCase(); %>
        <% const dest = (r.detailsJson && r.detailsJson.destination) || {}; %>
        <% const showBankAccount = r.bankAccount && r.status !== 'REJECTED'; %>
        <tr>
          <td data-col="txnId"><span class="mono"><%= r.referenceCode %></span></td>
          <td data-col="userId"><span class="mono"><%= r.user?.publicId || '-' %></span></td>
          <td data-col="merchant"><%= r.merchant?.name || '-' %></td>
          <td data-col="currency"><%= r.currency %></td>
          <td data-col="amount"><%= formatAmount(r.amountCents) %></td>
          <td data-col="status">
            <% if (r.status === 'SUBMITTED') { %>
              <span class="badge">Submitted</span>
            <% } else { %>
              <span class="badge warn">Pending</span>
            <% } %>
          </td>
          <td data-col="bank">
            <% if (showBankAccount) { %>
              <span class="mono"><%= r.bankAccount.publicId || '-' %></span><br>
              <%= r.bankAccount.bankName || '-' %>
            <% } else { %>
              -
            <% } %>
          </td>
          <td data-col="created"><%- renderDateTime(r.createdAt) %></td>
          <td data-col="processedAt">-</td>
          <td data-col="processingTime">-</td>
          <td data-col="userInfo" class="info-cell">
            <div class="info-block">
              <div class="info-line"><span class="info-label">Method</span><span class="info-value"><%= method || '-' %></span></div>
              <div class="info-line"><span class="info-label">Bank name</span><span class="info-value"><%= dest.bankName || r.bankAccount?.bankName || '-' %></span></div>
              <div class="info-line"><span class="info-label">Account holder name</span><span class="info-value"><%= dest.holderName || '-' %></span></div>
              <% if (method === 'OSKO') { %>
                <div class="info-line"><span class="info-label">Account number</span><span class="info-value"><%= dest.accountNo || '-' %></span></div>
                <div class="info-line"><span class="info-label">BSB</span><span class="info-value"><%= dest.bsb || '-' %></span></div>
              <% } else if (method === 'PAYID') { %>
                <div class="info-line"><span class="info-label">PayID</span><span class="info-value"><%= dest.payIdValue || '-' %></span></div>
              <% } %>
            </div>
          </td>
          <td data-col="comment">-</td>
          <td data-col="admin">-</td>
          <td data-col="actions" class="actions">
            <button
              type="button"
              class="btn small primary"
              data-approve
              data-id="<%= r.id %>"
              data-reference="<%= r.referenceCode %>"
              data-amount="<%= r.amountCents %>"
              data-amount-display="<%= formatAmount(r.amountCents) %> <%= r.currency %>"
              data-currency="<%= r.currency %>"
              data-method="<%= method %>"
              data-bank-id="<%= r.bankAccount?.id || '' %>"
            >Approve</button>
            <button
              type="button"
              class="btn small danger"
              data-reject
              data-id="<%= r.id %>"
              data-reference="<%= r.referenceCode %>"
              data-amount="<%= r.amountCents %>"
              data-currency="<%= r.currency %>"
            >Reject</button>
          </td>
        </tr>
      <% }) %>
    </tbody>
  </table>
</div>

<script type="application/json" id="withdraw-bank-options"><%- JSON.stringify(banks || []) %></script>
