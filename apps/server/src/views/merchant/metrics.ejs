<% layout('merchant/layout') -%>

<style>
  /* scoped only to this page */
  .metrics-toolbar details.metrics-dropdown { display:inline-block; position:relative; }
  .metrics-toolbar details.metrics-dropdown > summary { cursor:pointer; user-select:none; }
  .metrics-toolbar details.metrics-dropdown[open] .dropdown-panel {
    position:absolute; z-index:10; background:#fff; border:1px solid #e5e7eb; border-radius:8px;
    padding:10px; min-width:220px; box-shadow:0 8px 24px rgba(0,0,0,.08);
  }
  .metrics-toolbar .dropdown-panel label { display:flex; gap:8px; align-items:center; padding:4px 2px; }
  .metrics-toolbar .metrics-methods { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .metrics-toolbar .btn { padding:6px 10px; border:1px solid #d1d5db; border-radius:8px; background:#fff; }
  .metrics-toolbar .btn:hover { background:#f9fafb; }
</style>

<div class="metrics-toolbar" data-metrics-scope="merchant" data-merchant-id="<%= merchantId %>">
  <form class="metrics-filters" data-metrics-form>
    <label>
      <span>From</span>
      <input type="date" name="from"/>
    </label>
    <label>
      <span>To</span>
      <input type="date" name="to"/>
    </label>
    <label>
      <span>Timezone</span>
      <input type="text" name="tz" placeholder="Asia/Jakarta"/>
    </label>

    <div class="metrics-methods">
      <span>Methods</span>
      <!-- compact dropdown that keeps your original checkbox inputs -->
      <details class="metrics-dropdown">
        <summary class="btn">Choose</summary>
        <div class="dropdown-panel">
          <label><input type="checkbox" name="method" value="IDR_VA_DYNAMIC"/> <span>IDR v4 Dynamic</span></label>
          <label><input type="checkbox" name="method" value="IDR_VA_STATIC"/> <span>IDR v4 Static</span></label>
          <label><input type="checkbox" name="method" value="IDR_SEND"/> <span>IDR Send</span></label>
          <label><input type="checkbox" name="method" value="AUD_NPP"/> <span>AUD · NPP</span></label>
          <label><input type="checkbox" name="method" value="AUD_NPP_BANK"/> <span>AUD · NPP — Bank Account</span></label>
          <label><input type="checkbox" name="method" value="AUD_NPP_PAYID"/> <span>AUD · NPP — PayID</span></label>
          <label><input type="checkbox" name="method" value="P2P"/> <span>P2P</span></label>
        </div>
      </details>

      <div class="metrics-actions">
        <button type="submit" class="btn">Apply</button>
      </div>
    </div>
  </form>
</div>

<div class="kpis metrics-kpis" data-metrics-kpis>
  <div class="kpi">
    <div class="label">KYC Starts</div>
    <div class="value" data-kpi="kyc.starts">0</div>
  </div>
  <div class="kpi">
    <div class="label">KYC Completes</div>
    <div class="value" data-kpi="kyc.completes">0</div>
  </div>
  <div class="kpi">
    <div class="label">KYC Completion Rate</div>
    <div class="value" data-kpi="kyc.completionRate">0%</div>
  </div>
  <div class="kpi">
    <div class="label">Avg Approval Time</div>
    <div class="value" data-kpi="kyc.avgTimeToApprovalMs">0m</div>
  </div>
</div>

<div class="kpis metrics-kpis" data-metrics-kpis>
  <div class="kpi">
    <div class="label">VA Create Success</div>
    <div class="value" data-kpi="deposits.vaCreateSuccessRate">0%</div>
  </div>
  <div class="kpi">
    <div class="label">Approved Deposits</div>
    <div class="value" data-kpi="deposits.approvedCount">0</div>
  </div>
  <div class="kpi">
    <div class="label">Rejected Deposits</div>
    <div class="value" data-kpi="deposits.rejectedCount">0</div>
  </div>
  <div class="kpi">
    <div class="label">Approved Withdrawals</div>
    <div class="value" data-kpi="withdrawals.approvedCount">0</div>
  </div>
</div>

<div class="metrics-grid">
  <div class="card metrics-card">
    <div class="title">KYC Starts vs Completes</div>
    <div class="metrics-chart" data-chart="kyc"></div>
  </div>
  <div class="card metrics-card">
    <div class="title">Deposits Status</div>
    <div class="metrics-chart" data-chart="deposits"></div>
  </div>
  <div class="card metrics-card">
    <div class="title">Withdrawals Status</div>
    <div class="metrics-chart" data-chart="withdrawals"></div>
  </div>
</div>

<div class="metrics-grid">
  <div class="card metrics-card">
    <div class="title">Approved Volume by Method</div>
    <div class="metrics-breakdown" data-breakdown="methods"></div>
  </div>
  <div class="card metrics-card">
    <div class="title">Top Reject Reasons</div>
    <div class="metrics-table" data-breakdown="rejects"></div>
  </div>
  <div class="card metrics-card">
    <div class="title">Top Issues</div>
    <div class="metrics-table" data-breakdown="issues"></div>
  </div>
</div>

<script src="/static/shared/metrics.js" defer></script>
