<% layout('merchant/layout') -%>

<div
  class="card"
  data-test-payments
  data-session-endpoint="/merchant/payments/test/session"
  data-default-subject="<%= testCheckout.subject %>"
  data-initial-token="<%= testCheckout.token %>"
  style="display:flex; flex-direction:column; gap:14px;"
>
  <!-- Method group selector -->
  <div class="row" style="justify-content:center; gap:16px; flex-wrap:wrap;">
    <label class="form-line" style="display:grid; grid-template-columns: 96px 220px; gap:8px; align-items:center;">
      <span class="muted">Method</span>
      <select data-test-method>
        <option value="p2p" selected>P2P</option>
        <option value="idr-v4-dynamic">IDR v4 (Dynamic)</option>
        <option value="idr-v4-static">IDR v4 (Static)</option>
      </select>
    </label>
    <div data-test-message style="margin-top:2px; text-align:center; font-size:14px; opacity:.85; display:none;"></div>
  </div>

  <!-- P2P (unchanged; the shared widget handles its own overlay) -->
  <div data-test-section="p2p" style="display:block;">
    <div class="row" style="justify-content:center; gap:16px; margin-top:4px;">
      <button type="button" class="btn primary" data-test-action="deposit">Deposit</button>
      <button type="button" class="btn" data-test-action="withdrawal">Withdrawal</button>
    </div>
  </div>

  <!-- IDR v4: buttons only. We render a custom overlay on click. -->
  <div data-test-section="idr-v4" style="display:none;">
    <div class="row" style="justify-content:center; gap:16px; margin-top:2px;">
      <button type="button" class="btn primary" data-test-action="deposit">Deposit</button>
      <button type="button" class="btn" data-test-action="withdrawal">Withdrawal</button>
    </div>
  </div>
</div>

<script>
/* =============================================================================
   IDR v4 overlay (merchant test only). Uses IBGCheckoutV4 with API-key routes.
   + KYC gate: handle 403 { error: "KYC_REQUIRED", url }
============================================================================= */
(() => {
  const root = document.querySelector('[data-test-payments]');
  if (!root) return;

  const diditSubject = root.getAttribute('data-default-subject') || '';
  const sessionEndpoint = root.getAttribute('data-session-endpoint') || '/merchant/payments/test/session';

  const methodSelect = root.querySelector('[data-test-method]');
  const p2p = root.querySelector('[data-test-section="p2p"]');
  const idrv4 = root.querySelector('[data-test-section="idr-v4"]');

  const methodMap = {
    'idr-v4-dynamic': 'VIRTUAL_BANK_ACCOUNT_DYNAMIC',
    'idr-v4-static': 'VIRTUAL_BANK_ACCOUNT_STATIC',
  };

  const setMessage = (text, variant = 'info') => {
    const el = root.querySelector('[data-test-message]');
    if (!el) return;
    el.textContent = text || '';
    el.style.display = text ? '' : 'none';
    el.style.color = variant === 'error' ? 'var(--danger, #b91c1c)' : '';
    el.style.opacity = text ? '.9' : '.85';
  };

  const getMode = () => (methodSelect?.value || 'p2p').toLowerCase();

  const showSection = (mode) => {
    if (mode.startsWith('idr-v4')) {
      p2p.style.display = 'none';
      idrv4.style.display = '';
      setMessage('IDR v4 selected.');
    } else {
      p2p.style.display = '';
      idrv4.style.display = 'none';
      setMessage('');
    }
  };

  showSection(getMode());
  methodSelect?.addEventListener('change', (event) => {
    if (getMode().startsWith('idr-v4')) event.stopImmediatePropagation();
    showSection(getMode());
  }, true);

  const disableIdrButtons = (disabled) => {
    idrv4?.querySelectorAll('[data-test-action]').forEach((btn) => {
      btn.disabled = !!disabled;
      btn.style.opacity = disabled ? '.6' : '';
    });
  };

  const ensureWidget = async () => {
    if (window.IBGCheckoutV4) return window.IBGCheckoutV4;
    await new Promise((resolve) => window.addEventListener('load', resolve, { once: true }));
    return window.IBGCheckoutV4;
  };

  const initWidget = async (session) => {
    if (!session?.apiKey) return;
    const widget = await ensureWidget();
    if (!widget) return;
    widget.init({
      apiBase: '/api/v1',
      merchantBase: '/merchant',
      token: session.apiKey,
      diditSubject: session.diditSubject || diditSubject || '',
    });
  };

  const fetchSession = async (payload) => {
    const resp = await fetch(sessionEndpoint, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify(payload || {}),
    });
    const data = await resp.json().catch(() => ({}));
    if (!resp.ok || !data?.ok) {
      const err = new Error(data?.message || data?.error || 'Unable to start session');
      err.code = data?.error;
      if (data?.url) err.url = data.url;            // pass KYC link through
      if (data?.clientStatus) err.clientStatus = data.clientStatus;
      throw err;
    }
    return data;
  };

  // NEW: run KYC if required; poll until verified, then return a session
  const ensureKycThenSession = async (payload) => {
    try {
      return await fetchSession(payload); // will throw if KYC_REQUIRED
    } catch (err) {
      if (err?.code !== 'KYC_REQUIRED' || !err?.url) throw err;

      // Launch Didit
      setMessage('Verification required — a window was opened. Complete KYC to continue…');
      const w = window.open(err.url, 'didit', 'width=420,height=720');

      // Poll the same endpoint until it returns ok:true
      const started = Date.now();
      const MAX_MS = 6 * 60 * 1000;          // 6 minutes
      const INTERVAL = 2000;

      return await new Promise((resolve, reject) => {
        const t = setInterval(async () => {
          if ((Date.now() - started) > MAX_MS || (w && w.closed)) {
            clearInterval(t);
            try { w && w.close(); } catch {}
            setMessage('Verification not completed.', 'error');
            return reject(Object.assign(new Error('Verification not completed'), { code: 'KYC_TIMEOUT' }));
          }
          try {
            const s = await fetchSession(payload);
            clearInterval(t);
            try { w && w.close(); } catch {}
            setMessage('');
            resolve(s);
          } catch (e) {
            if (e?.code && e.code !== 'KYC_REQUIRED') {
              clearInterval(t);
              try { w && w.close(); } catch {}
              setMessage(e.message || 'Unable to continue.', 'error');
              reject(e);
            }
            // else keep polling on KYC_REQUIRED
          }
        }, INTERVAL);
      });
    }
  };

  const ensureSessionFor = async (method) => {
    const payload = {
      subject: diditSubject,
      method,
      currency: getMode().startsWith('idr-v4') ? 'IDR' : undefined,
    };
    try {
      disableIdrButtons(true);
      const session = await ensureKycThenSession(payload);
      await initWidget(session);
      disableIdrButtons(false);
      setMessage('');
      return true;
    } catch (err) {
      if (err?.code === 'NO_API_KEY_OR_SCOPE') {
        setMessage('No API key with the required scopes. Create one in API Keys and ask Super Admin to assign scopes.', 'error');
        disableIdrButtons(true);
        return false;
      }
      setMessage((err && err.message) || 'Unable to initialize IDR v4 checkout.', 'error');
      disableIdrButtons(true);
      return false;
    }
  };

  const primeSession = () => {
    // Don’t auto-open KYC on page load; ignore errors here.
    const mode = getMode();
    const method = mode.startsWith('idr-v4') ? 'idr-v4-deposit' : 'p2p';
    fetchSession({ subject: diditSubject, method, currency: mode.startsWith('idr-v4') ? 'IDR' : undefined })
      .then((session) => initWidget(session))
      .catch(() => {});
  };

  primeSession();

  // Intercept clicks for IDR v4 so P2P widget does not open.
  root.addEventListener('click', (e) => {
    const btn = e.target.closest('[data-test-action]');
    if (!btn) return;
    if (!getMode().startsWith('idr-v4')) return; // let P2P flow as-is
    e.preventDefault();
    e.stopPropagation();
    const kind = (btn.getAttribute('data-test-action') || '').toLowerCase();
    const method = kind === 'withdrawal' ? 'idr-v4-withdrawal' : 'idr-v4-deposit';
    ensureSessionFor(method).then((ok) => {
      if (!ok) return;
      const mode = getMode();
      const methodCode = methodMap[mode] || methodMap['idr-v4-dynamic'];
      if (kind === 'withdrawal') {
        window.IBGCheckoutV4?.openWithdrawal();
      } else {
        window.IBGCheckoutV4?.openDeposit({ method: methodCode });
      }
    });
  }, true);
})();
</script>