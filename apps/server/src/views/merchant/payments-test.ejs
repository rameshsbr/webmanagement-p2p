<% layout('merchant/layout') -%>

<div
  class="card"
  data-test-payments
  data-session-endpoint="/merchant/payments/test/session"
  data-default-subject="<%= testCheckout.subject %>"
  data-initial-token="<%= testCheckout.token %>"
  data-idrv4-api-key="<%= testCheckout.idrV4ApiKey || '' %>"
  data-idrv4-kyc-name="<%= testCheckout.verifiedKycName || '' %>"
  style="display:flex; flex-direction:column; gap:14px;"
>
  <!-- Method group selector -->
  <div class="row" style="justify-content:center; gap:16px; flex-wrap:wrap;">
    <label class="form-line" style="display:grid; grid-template-columns: 96px 220px; gap:8px; align-items:center;">
      <span class="muted">Method</span>
      <select data-test-method>
        <option value="p2p" selected>P2P</option>
        <option value="idr-v4-dynamic">IDR v4 (Dynamic)</option>
        <option value="idr-v4-static">IDR v4 (Static)</option>
      </select>
    </label>
    <div data-test-message style="margin-top:2px; text-align:center; font-size:14px; opacity:.85; display:none;"></div>
  </div>

  <!-- P2P (unchanged; the shared widget handles its own overlay) -->
  <div data-test-section="p2p" style="display:block;">
    <div class="row" style="justify-content:center; gap:16px; margin-top:4px;">
      <button type="button" class="btn primary" data-test-action="deposit">Deposit</button>
      <button type="button" class="btn" data-test-action="withdrawal">Withdrawal</button>
    </div>
  </div>

  <!-- IDR v4: buttons only. We render a custom overlay on click. -->
  <section class="card" style="margin-top:12px" data-test-section="idr-v4">
    <div class="card__header">
      <h3 style="margin:0;">IDR v4</h3>
    </div>
    <div class="row" style="justify-content:center; gap:16px; margin-top:4px;">
      <button type="button" class="btn primary" data-test-action="deposit">Deposit</button>
      <button type="button" class="btn" data-test-action="withdrawal">Withdrawal</button>
    </div>
    <div class="muted" style="text-align:center; font-size:12px; margin-top:6px;">
      Uses VA rails and FAZZ disbursements. Amounts are in IDR cents (no decimals).
    </div>
  </section>
</div>

<script>
/* =============================================================================
   IDR v4 overlay (merchant test only). Isolated from P2P widget.
   - Deposit: POST /api/v1/deposit/intents?debug=1 (VA Dynamic/Static)
   - Withdrawal: POST /api/v1/withdrawals (FAZZ_SEND)
   - Meta: GET /merchant/idrv4/meta
   - Validate: POST /merchant/idrv4/validate
============================================================================= */
(() => {
  const root = document.querySelector('[data-test-payments]');
  if (!root) return;

  const apiToken = root.getAttribute('data-idrv4-api-key') || '';
  const diditSubject = root.getAttribute('data-default-subject') || '';
  const verifiedKycName = (root.getAttribute('data-idrv4-kyc-name') || '').trim();

  const methodSelect = root.querySelector('[data-test-method]');
  const p2p = root.querySelector('[data-test-section="p2p"]');
  const idrv4 = root.querySelector('[data-test-section="idr-v4"]');

  const methodMap = {
    'idr-v4-dynamic': 'VIRTUAL_BANK_ACCOUNT_DYNAMIC',
    'idr-v4-static': 'VIRTUAL_BANK_ACCOUNT_STATIC',
  };

  const setMessage = (text, variant = 'info') => {
    const el = root.querySelector('[data-test-message]');
    if (!el) return;
    el.textContent = text || '';
    el.style.display = text ? '' : 'none';
    el.style.color = variant === 'error' ? 'var(--danger, #b91c1c)' : '';
    el.style.opacity = text ? '.9' : '.85';
  };

  const getMode = () => (methodSelect?.value || 'p2p').toLowerCase();

  const showSection = (mode) => {
    if (mode.startsWith('idr-v4')) {
      p2p.style.display = 'none';
      idrv4.style.display = '';
      setMessage('IDR v4 selected.');
    } else {
      p2p.style.display = '';
      idrv4.style.display = 'none';
      setMessage('');
    }
  };

  showSection(getMode());
  methodSelect?.addEventListener('change', () => showSection(getMode()));

  const normalizeName = (value) =>
    String(value || '')
      .toLowerCase()
      .replace(/[^a-z0-9\s]/g, ' ')
      .replace(/\s+/g, ' ')
      .trim();

  const nameScore = (a, b) => {
    const left = normalizeName(a);
    const right = normalizeName(b);
    if (!left || !right) return 0;
    const leftWords = new Set(left.split(' '));
    const rightWords = new Set(right.split(' '));
    let common = 0;
    leftWords.forEach((w) => { if (rightWords.has(w)) common += 1; });
    return common / Math.max(leftWords.size, rightWords.size, 1);
  };

  const money = (value) => {
    const raw = String(value || '').replace(/,/g, '').trim();
    if (!raw) return null;
    const num = Number(raw);
    if (!Number.isFinite(num) || num <= 0) return null;
    return Math.round(num);
  };

  const h = (tag, attrs = {}, kids = []) => {
    const el = document.createElement(tag);
    for (const [k, v] of Object.entries(attrs)) {
      if (k === 'class') el.className = v;
      else if (k === 'style') el.style.cssText = v;
      else if (k === 'html') el.innerHTML = v;
      else el.setAttribute(k, v);
    }
    [].concat(kids).forEach((c) => el.appendChild(typeof c === 'string' ? document.createTextNode(c) : c));
    return el;
  };

  function authHeaders() {
    if (!apiToken) return {};
    return { authorization: `Bearer ${apiToken}` };
  }

  async function apiPost(path, body) {
    const resp = await fetch(`/api/v1${path}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', ...authHeaders() },
      credentials: 'same-origin',
      body: JSON.stringify(body || {}),
    });
    const data = await resp.json().catch(() => ({}));
    if (!resp.ok || data?.ok === false) throw new Error(data?.error || data?.message || 'Request failed');
    return data;
  }

  async function loadMeta(methodCode) {
    const url = `/merchant/idrv4/meta?method=${encodeURIComponent(methodCode)}`;
    const resp = await fetch(url, { credentials: 'same-origin' });
    const data = await resp.json().catch(() => ({}));
    if (!resp.ok || !data?.ok) throw new Error(data?.error || 'Unable to load meta');
    return data;
  }

  function openModal(builder) {
    const overlay = h('div', { class: 'payx-overlay', style: `
      position: fixed; inset: 0; background: rgba(0,0,0,.35); display:flex; align-items:center; justify-content:center; z-index:9999;`
    });
    const box = h('div', { class: 'payx-box', style: `
      background: var(--card-bg, #fff); color: inherit; border-radius: 10px; min-width: 420px; max-width: 720px;
      box-shadow: 0 8px 24px rgba(0,0,0,.2); padding: 16px;`
    });
    const close = () => overlay.remove();
    overlay.addEventListener('click', (e) => { if (e.target === overlay) close(); });
    box.appendChild(h('div', { style:'display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;' }, [
      h('div', { class:'muted', style:'font-weight:600;' }, 'IDR v4'),
      h('button', { class:'btn small', type:'button' }, 'Close')
    ]));
    box.querySelector('button')?.addEventListener('click', close);
    const body = h('div');
    box.appendChild(body);
    overlay.appendChild(box);
    document.body.appendChild(overlay);
    builder(body, close);
  }

  async function openIdrDeposit() {
    const mode = getMode();
    const methodCode = methodMap[mode] || methodMap['idr-v4-dynamic'];

    openModal(async (body, close) => {
      const form = h('form', { style:'display:grid; gap:10px;' });
      const amount = h('input', { class:'input', inputmode:'numeric', placeholder:'Amount (IDR cents)' });
      const fullName = h('input', { class:'input', placeholder:'Full name' });
      const bank = h('select', { class:'input' });
      const warning = h('div', { class:'muted', style:'font-size:12px; color:#b91c1c; display:none;' });
      const hint = h('div', { class:'muted', style:'font-size:12px;' }, 'Full name must match verified KYC name (if available).');

      const actions = h('div', { style:'display:flex; gap:8px; justify-content:flex-end;' }, [
        h('button', { class:'btn', type:'button' }, 'Cancel'),
        h('button', { class:'btn primary', type:'submit' }, 'Create VA')
      ]);
      actions.firstChild.addEventListener('click', close);

      const row = (label, el) => h('label', { class:'form-line', style:'display:grid; grid-template-columns: 160px 1fr; gap:8px; align-items:center;' },
        [ h('span', { class:'muted' }, label), el ]);

      form.append(
        row('Amount (IDR)', amount),
        row('Full name', fullName),
        row('Bank (VA)', bank),
        hint,
        warning,
        actions,
      );
      body.appendChild(form);

      if (!apiToken) {
        warning.style.display = '';
        warning.textContent = 'Missing API token for IDR v4. Create a key with write scopes first.';
        actions.lastChild.disabled = true;
        return;
      }

      let limits = { minDeposit: null, maxDeposit: null };
      try {
        const meta = await loadMeta(methodCode);
        const banks = Array.isArray(meta?.banks) ? meta.banks : [];
        limits = meta?.limits || limits;
        bank.innerHTML = '';
        banks.forEach((code) => bank.appendChild(h('option', { value: code }, code)));
      } catch (err) {
        warning.style.display = '';
        warning.textContent = (err && err.message) || 'Unable to load banks.';
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        warning.style.display = 'none';

        const amountCents = money(amount.value);
        if (!amountCents) {
          warning.textContent = 'Enter a valid amount.'; warning.style.display = ''; return;
        }
        if (typeof limits.minDeposit === 'number' && amountCents < limits.minDeposit) {
          warning.textContent = `Amount must be ≥ ${limits.minDeposit.toLocaleString('en-US')} IDR.`; warning.style.display = ''; return;
        }
        if (typeof limits.maxDeposit === 'number' && amountCents > limits.maxDeposit) {
          warning.textContent = `Amount must be ≤ ${limits.maxDeposit.toLocaleString('en-US')} IDR.`; warning.style.display = ''; return;
        }
        const name = String(fullName.value || '').trim();
        if (!name) { warning.textContent = 'Enter the full name.'; warning.style.display = ''; return; }
        if (verifiedKycName) {
          const score = nameScore(name, verifiedKycName);
          if (score < 0.6) {
            warning.textContent = 'Full name must match the verified KYC name.';
            warning.style.display = '';
            return;
          }
        }

        const payload = {
          user: { diditSubject },
          amountCents,
          currency: 'IDR',
          bankCode: String(bank.value || ''),
          methodCode,
          paymentMethodDisplayName: name,
        };

        actions.lastChild.disabled = true;
        try {
          const data = await apiPost('/deposit/intents?debug=1', payload);
          const intent = data?.data || data;
          const va = intent?.va || {};
          body.innerHTML = '';
          body.appendChild(h('div', { class:'muted', style:'margin-bottom:6px;' }, 'Transfer details'));
          const grid = h('div', { style:'display:grid; grid-template-columns: 160px 1fr; gap:6px;' }, [
            h('div', { class:'muted' }, 'Reference'), h('div', { class:'mono' }, intent?.referenceCode || '-'),
            h('div', { class:'muted' }, 'Bank'), h('div', {}, va.bankCode || '-'),
            h('div', { class:'muted' }, 'Account No'), h('div', { class:'mono' }, va.accountNo || '-'),
            h('div', { class:'muted' }, 'Account Name'), h('div', {}, va.accountName || '-'),
            h('div', { class:'muted' }, 'Amount'), h('div', { class:'mono' }, `IDR ${amountCents.toLocaleString('en-US')}`),
          ]);
          body.appendChild(grid);

          const statusEl = h('div', { class:'muted', style:'margin-top:10px;' }, 'Awaiting payment confirmation.');
          const pollBtn = h('button', { class:'btn primary', type:'button', style:'margin-top:10px;' }, "I've paid");
          const backBtn = h('button', { class:'btn', type:'button', style:'margin-left:8px;' }, 'Back');
          const footer = h('div', { style:'display:flex; justify-content:flex-end; gap:8px; margin-top:12px;' }, [backBtn, pollBtn]);
          body.appendChild(statusEl);
          body.appendChild(footer);

          backBtn.addEventListener('click', close);
          pollBtn.addEventListener('click', async () => {
            pollBtn.disabled = true;
            statusEl.textContent = 'Checking status…';
            let attempts = 0;
            const interval = setInterval(async () => {
              attempts += 1;
              try {
                const confirm = await apiPost('/deposit/confirm', { id: intent?.id });
                const status = confirm?.status || confirm?.data?.status || 'PENDING';
                statusEl.textContent = `Status: ${status}`;
                if (status === 'APPROVED' || attempts >= 20) {
                  clearInterval(interval);
                  pollBtn.disabled = false;
                }
              } catch (err) {
                clearInterval(interval);
                pollBtn.disabled = false;
                statusEl.textContent = (err && err.message) || 'Unable to confirm payment.';
              }
            }, 2500);
          });
        } catch (err) {
          warning.textContent = (err && err.message) || 'Unable to create deposit.';
          warning.style.display = '';
        } finally {
          actions.lastChild.disabled = false;
        }
      });
    });
  }

  async function openIdrWithdrawal() {
    openModal(async (body, close) => {
      const form = h('form', { style:'display:grid; gap:10px;' });
      const amount = h('input', { class:'input', inputmode:'numeric', placeholder:'Amount (IDR cents)' });
      const bank = h('input', { class:'input', placeholder:'Bank code (e.g., BCA)' });
      const holderName = h('input', { class:'input', placeholder:'Account holder name' });
      const accountNo = h('input', { class:'input', placeholder:'Account number' });
      const validateBtn = h('button', { class:'btn', type:'button' }, 'Validate');
      const validateMsg = h('span', { class:'muted' });
      const submitBtn = h('button', { class:'btn primary', type:'submit', disabled:'disabled' }, 'Submit withdraw');
      const warning = h('div', { class:'muted', style:'font-size:12px; color:#b91c1c; display:none;' });

      const row = (label, el) => h('label', { class:'form-line', style:'display:grid; grid-template-columns: 180px 1fr; gap:8px; align-items:center;' },
        [ h('span', { class:'muted' }, label), el ]);

      const actions = h('div', { style:'display:flex; gap:8px; justify-content:flex-end;' }, [
        h('button', { class:'btn', type:'button' }, 'Cancel'),
        submitBtn,
      ]);
      actions.firstChild.addEventListener('click', close);

      form.append(
        row('Amount (IDR)', amount),
        row('Bank code', bank),
        row('Account holder name', holderName),
        row('Account number', accountNo),
        h('div', { style:'display:flex; gap:8px; align-items:center;' }, [validateBtn, validateMsg]),
        warning,
        actions,
      );
      body.appendChild(form);

      if (!apiToken) {
        warning.style.display = '';
        warning.textContent = 'Missing API token for IDR v4. Create a key with write scopes first.';
        submitBtn.disabled = true;
        validateBtn.disabled = true;
        return;
      }

      let limits = { minWithdrawal: null, maxWithdrawal: null };
      try {
        const meta = await loadMeta(methodMap['idr-v4-dynamic']);
        limits = meta?.limits || limits;
      } catch {
        // ignore; limits are optional
      }

      validateBtn.addEventListener('click', async () => {
        warning.style.display = 'none';
        const amt = money(amount.value);
        if (!amt) { warning.textContent = 'Enter a valid amount.'; warning.style.display = ''; return; }
        if (typeof limits.minWithdrawal === 'number' && amt < limits.minWithdrawal) {
          warning.textContent = `Amount must be ≥ ${limits.minWithdrawal.toLocaleString('en-US')} IDR.`; warning.style.display = ''; return;
        }
        if (typeof limits.maxWithdrawal === 'number' && amt > limits.maxWithdrawal) {
          warning.textContent = `Amount must be ≤ ${limits.maxWithdrawal.toLocaleString('en-US')} IDR.`; warning.style.display = ''; return;
        }

        const name = String(holderName.value || '').trim();
        const acc = String(accountNo.value || '').trim();
        const code = String(bank.value || '').trim();
        if (!name || !acc || !code) {
          warning.textContent = 'Fill all fields first.'; warning.style.display = ''; return;
        }

        validateMsg.textContent = 'Validating…';
        validateBtn.disabled = true;
        try {
          const res = await fetch('/merchant/idrv4/validate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ bankCode: code, accountNo: acc, name }),
          });
          const data = await res.json().catch(() => ({}));
          if (!res.ok || !data?.ok) throw new Error(data?.error || 'Validation failed');
          const score = nameScore(name, data?.holder || '');
          if (score >= 0.6) {
            validateMsg.textContent = `Validated ✓ (match ${(score * 100).toFixed(0)}%)`;
            submitBtn.disabled = false;
          } else {
            validateMsg.textContent = `Name mismatch (match ${(score * 100).toFixed(0)}%).`;
            submitBtn.disabled = true;
          }
        } catch (err) {
          validateMsg.textContent = (err && err.message) || 'Validation error';
          submitBtn.disabled = true;
        } finally {
          validateBtn.disabled = false;
        }
      });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        warning.style.display = 'none';

        const amountCents = money(amount.value);
        if (!amountCents) { warning.textContent = 'Enter a valid amount.'; warning.style.display = ''; return; }

        const payload = {
          user: { diditSubject },
          amountCents,
          currency: 'IDR',
          methodCode: 'FAZZ_SEND',
          destination: {
            bankCode: String(bank.value || '').trim(),
            holderName: String(holderName.value || '').trim(),
            accountNo: String(accountNo.value || '').trim(),
          },
        };

        submitBtn.disabled = true;
        try {
          const data = await apiPost('/withdrawals', payload);
          const result = data?.data || data;
          body.innerHTML = '';
          body.appendChild(h('div', { class:'muted', style:'margin-bottom:6px;' }, 'Withdrawal submitted'));
          body.appendChild(h('div', { class:'mono' }, `Reference: ${result?.referenceCode || '-'}`));
          const statusEl = h('div', { class:'muted', style:'margin-top:10px;' }, 'Status: PENDING');
          const refresh = h('button', { class:'btn primary', type:'button', style:'margin-top:8px;' }, 'Refresh status');
          const closeBtn = h('button', { class:'btn', type:'button', style:'margin-left:8px; margin-top:8px;' }, 'Close');
          const footer = h('div', { style:'display:flex; gap:8px; justify-content:flex-end;' }, [closeBtn, refresh]);
          body.appendChild(statusEl);
          body.appendChild(footer);

          closeBtn.addEventListener('click', close);
          refresh.addEventListener('click', async () => {
            refresh.disabled = true;
            try {
              const confirm = await apiPost('/withdraw/confirm', { referenceCode: result?.referenceCode });
              const status = confirm?.status || confirm?.data?.status || 'PENDING';
              statusEl.textContent = `Status: ${status}`;
            } catch (err) {
              statusEl.textContent = (err && err.message) || 'Unable to refresh status.';
            } finally {
              refresh.disabled = false;
            }
          });
        } catch (err) {
          warning.textContent = (err && err.message) || 'Unable to submit withdrawal.';
          warning.style.display = '';
        } finally {
          submitBtn.disabled = false;
        }
      });
    });
  }

  // Intercept clicks for IDR v4 so P2P widget does not open.
  root.addEventListener('click', (e) => {
    const btn = e.target.closest('[data-test-action]');
    if (!btn) return;
    if (!getMode().startsWith('idr-v4')) return; // let P2P flow as-is
    e.preventDefault();
    e.stopPropagation();
    e.stopImmediatePropagation();
    const kind = (btn.getAttribute('data-test-action') || '').toLowerCase();
    if (kind === 'deposit') openIdrDeposit();
    else if (kind === 'withdrawal') openIdrWithdrawal();
  }, true);
})();
</script>
