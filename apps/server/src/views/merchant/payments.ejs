<% layout('merchant/layout') -%>

<%- include('../partials/filters-bar', { query }) %>

<div class="table-wrap">
  <!-- Export controls above the table, right-aligned -->
  <div class="row" style="justify-content:flex-end; gap:8px; margin-bottom:8px;">
    <% const qp = new URLSearchParams(query); %>
    <a class="btn small" href="/merchant/export/payments.csv?<%= qp.toString() %>">Export CSV</a>
    <a class="btn small" href="/merchant/export/payments.xlsx?<%= qp.toString() %>">Export XLSX</a>
  </div>

  <!-- BEGIN: Checkout demo panel (only appears when server gave us a token) -->
  <div id="payx-demo" style="display:<%= typeof checkoutToken !== 'undefined' ? 'block' : 'none' %>;
                              margin: 12px 0 20px 0; padding:12px; border:1px solid var(--ink-2); border-radius:10px;">
    <div class="row" style="align-items:center; gap:10px;">
      <div style="font-weight:600;">Test checkout</div>
      <div style="opacity:.7;">Subject:</div>
      <code><%= (query.subject || query.diditSubject || '') %></code>
      <span style="flex:1"></span>
      <button class="btn small" id="payx-open-dep">Open deposit</button>
      <button class="btn small" id="payx-open-wdr">Open withdrawal</button>
    </div>
    <div id="payx-demo-log" style="margin-top:8px; font-size:12px; opacity:.8;"></div>
  </div>
  <!-- END: Checkout demo panel -->

  <table class="table">
    <thead>
      <tr>
        <th>REFERENCE</th>
        <th>TYPE</th>
        <th>STATUS</th>
        <th>CURRENCY</th>
        <th>AMOUNT</th>
        <th>BANK</th>
        <th>CREATED</th>
        <th>UPDATED</th>
        <th>RECEIPT</th>
      </tr>
    </thead>
    <tbody>
      <% if (!table.items.length) { %>
        <tr><td colspan="9" style="text-align:center;color:var(--ink-dim)">No data</td></tr>
      <% } %>
      <% table.items.forEach(r => { %>
        <tr>
          <td><%= r.referenceCode %></td>
          <td><%= r.type %></td>
          <td><%= r.status %></td>
          <td><%= r.currency %></td>
          <td><%= formatAmount(r.amountCents, r.currency) %></td>
          <td><%= r.bankAccount?.bankName || '-' %></td>
          <td><%= formatDateTime(r.createdAt) %></td>
          <td><%= formatDateTime(r.updatedAt) %></td>
          <td>
            <% if (r.receiptFile) { %>
              <a class="btn small" target="_blank" href="<%= r.receiptFile.path.startsWith('/') ? r.receiptFile.path : ('/uploads/'+r.receiptFile.path) %>">View</a>
            <% } else { %>-<% } %>
          </td>
        </tr>
      <% }) %>
    </tbody>
  </table>
</div>

<div class="pagination">
  <% let sp = new URLSearchParams(query); %>
  <% if (table.page>1) { sp.set('page', String(table.page-1)); %>
    <a href="?<%= sp.toString() %>">&larr; Prev</a>
  <% } else { %><span>Prev</span><% } %>
  <span>Showing <%= table.items.length %> / <%= table.total %> • Page <%= table.page %> / <%= table.pages %></span>
  <% if (table.page<table.pages) { sp.set('page', String(table.page+1)); %>
    <a href="?<%= sp.toString() %>">Next &rarr;</a>
  <% } else { %><span>Next</span><% } %>
</div>

<!-- Widget + merchant glue (only loaded when token exists) -->
<% if (typeof checkoutToken !== 'undefined') { %>
  <script>
    window.CHECKOUT_TOKEN = "<%- checkoutToken %>";
  </script>
  <script src="/public/checkout/checkout-widget.js?v=2"></script>
  <script src="/public/merchant/merchant.js" defer></script>
  <script>
    // Minimal boot in case merchant.js didn’t run for some reason
    (async () => {
      try {
        if (window.PayX && window.CHECKOUT_TOKEN) {
          await PayX.init({
            token: window.CHECKOUT_TOKEN,
            theme: (document.cookie.match(/merchant_theme=(dark)/)?.[1] || "light"),
            onKycApproved:  info => document.getElementById('payx-demo-log').textContent = "KYC approved",
            onKycRejected:  info => document.getElementById('payx-demo-log').textContent = "KYC rejected",
            onDepositSubmitted:    info => document.getElementById('payx-demo-log').textContent = "Deposit " + info.referenceCode,
            onWithdrawalSubmitted: info => document.getElementById('payx-demo-log').textContent = "Withdrawal " + info.referenceCode,
            onError: err => document.getElementById('payx-demo-log').textContent = "Error: " + (err && (err.error || err.message) || String(err)),
          });
          document.getElementById('payx-open-dep')?.addEventListener('click', () => PayX.openDeposit());
          document.getElementById('payx-open-wdr')?.addEventListener('click', () => PayX.openWithdrawal());
        }
      } catch {}
    })();
  </script>
<% } %>