<% layout('merchant/layout') -%>

<%- include('../partials/filters-bar', { query }) %>

<%- include('../partials/column-settings', {
  key: 'merchant.columns.payments',
  defaults: {
    txnId:true,
    userId:true,
    type:true,
    currency:true,
    amount:true,
    status:true,
    bank:true,
    created:true,
    processedAt:true,
    processingTime:true,
    userInfo:true,
    comment:true,
    admin:true
  },
  labelMap: {
    txnId: 'Transaction ID',
    type: 'Type',
    processedAt: 'Date processed',
    processingTime: 'Time to process',
    comment: 'Comment',
    admin: 'Processed by'
  }
}) %>

<%
  let perPageOptions = [25, 50, 100, 150];
  const perPageValue = Number(table.perPage || 25);
  if (!perPageOptions.includes(perPageValue)) {
    perPageOptions = [...perPageOptions, perPageValue].sort((a, b) => a - b);
  }
  const perPageSelectId = 'perPage-merchant-payments';
  const tableId = 'merchant-payments-table';
  const columnsSelector = "[data-storage-key='merchant.columns.payments']";
%>
<div class="table-toolbar">
  <div class="export-control" data-export-control data-export-endpoint="/merchant/export/payments" data-export-table="#<%= tableId %>" data-export-columns-root="<%= columnsSelector %>" data-export-storage="merchant.export.payments">
    <button type="button" class="btn small" data-export-main>
      <span data-export-label>Export</span>
    </button>
    <button type="button" class="btn small btn-icon" data-export-toggle aria-label="Select export format">▾</button>
    <div class="export-menu" data-export-menu hidden>
      <button type="button" data-export-option="csv">CSV</button>
      <button type="button" data-export-option="xlsx">XLSX</button>
      <button type="button" data-export-option="pdf">PDF</button>
    </div>
  </div>
  <form method="get">
    <% Object.entries(query || {}).forEach(([key, value]) => {
         if (value === undefined || value === null || value === '' || key === 'perPage' || key === 'page') return;
    %>
      <input type="hidden" name="<%= key %>" value="<%= value %>">
    <% }); %>
    <input type="hidden" name="page" value="1">
    <label for="<%= perPageSelectId %>">Rows per page</label>
    <select id="<%= perPageSelectId %>" name="perPage" onchange="this.form.submit()">
      <% perPageOptions.forEach((size) => { %>
        <option value="<%= size %>" <%= perPageValue === size ? 'selected' : '' %>><%= size %></option>
      <% }); %>
    </select>
  </form>
</div>

<div class="table-wrap">

  <% if (typeof checkoutToken !== 'undefined') { %>
    <div id="payx-demo" style="margin: 12px 0 20px 0; padding:12px; border:1px solid var(--muted); border-radius:10px;">
      <div class="row" style="align-items:center; gap:10px;">
        <div style="font-weight:600;">Test checkout</div>
        <div style="opacity:.7;">Subject:</div>
        <code><%= (query.subject || query.diditSubject || '') %></code>
        <span style="flex:1"></span>
        <button class="btn small" id="payx-open-dep">Open deposit</button>
        <button class="btn small" id="payx-open-wdr">Open withdrawal</button>
      </div>
      <div id="payx-demo-log" style="margin-top:8px; font-size:12px; opacity:.8;"></div>
    </div>
  <% } %>

  <table id="<%= tableId %>" class="table">
    <thead>
      <tr>
        <th data-col="txnId">TRANSACTION ID</th>
        <th data-col="userId">USER ID</th>
        <th data-col="type">TYPE</th>
        <th data-col="currency">CURRENCY</th>
        <th data-col="amount">AMOUNT</th>
        <th data-col="status">STATUS</th>
        <th data-col="bank">BANK</th>
        <th data-col="created">DATE OF CREATION</th>
        <th data-col="processedAt">DATE PROCESSED</th>
        <th data-col="processingTime">TIME TO PROCESS</th>
        <th data-col="userInfo">USER INFO</th>
        <th data-col="comment">COMMENT</th>
        <th data-col="admin">PROCESSED BY</th>
      </tr>
    </thead>
    <tbody>
      <% if (!table.items.length) { %>
        <tr><td colspan="13" style="text-align:center;color:var(--ink-dim)">No data</td></tr>
      <% } %>
      <% table.items.forEach(r => { %>
        <% const details = (r.detailsJson || {}); %>
        <% const methodRaw = (details.method || (r.bankAccount && r.bankAccount.method) || ''); %>
        <% const method = (methodRaw || '').toUpperCase(); %>
        <% const payer = details.payer || {}; %>
        <% const payerBankName = payer.bankName || (r.bankAccount && r.bankAccount.bankName) || null; %>
        <% const destination = details.destination || {}; %>
        <% const processedAt = r.processedAt || r.updatedAt || null; %>
        <% const hasProcessed = processedAt && !(r.status === 'PENDING' || r.status === 'SUBMITTED'); %>
        <% const showBankAccount = r.bankAccount && (r.type !== 'WITHDRAWAL' || r.status !== 'REJECTED'); %>
        <tr>
          <td data-col="txnId"><span class="mono"><%= r.referenceCode %></span></td>
          <td data-col="userId"><span class="mono"><%= r.user?.publicId || '-' %></span></td>
          <td data-col="type"><%= r.type %></td>
          <td data-col="currency"><%= r.currency %></td>
          <td data-col="amount"><%= formatAmount(r.amountCents) %></td>
          <td data-col="status">
            <% if (r.status==='APPROVED') { %><span class="badge success">Approved</span><% } %>
            <% if (r.status==='REJECTED') { %><span class="badge danger">Rejected</span><% } %>
            <% if (r.status==='PENDING')  { %><span class="badge warn">Pending</span><% } %>
            <% if (r.status==='SUBMITTED'){ %><span class="badge">Submitted</span><% } %>
          </td>
          <td data-col="bank">
            <% if (showBankAccount) { %>
              <span class="mono"><%= r.bankAccount.publicId || '-' %></span><br>
              <%= r.bankAccount.bankName || '-' %>
            <% } else { %>
              -
            <% } %>
          </td>
          <td data-col="created"><%- renderDateTime(r.createdAt) %></td>
          <td data-col="processedAt"><%- hasProcessed ? renderDateTime(processedAt) : '-' %></td>
          <td data-col="processingTime"><%= hasProcessed ? formatDuration(r.createdAt, processedAt) : '-' %></td>
          <td data-col="userInfo" class="info-cell">
            <div class="info-block">
              <div class="info-line"><span class="info-label">Unique Reference No</span><span class="info-value"><%= r.uniqueReference %></span></div>
              <div class="info-line"><span class="info-label">Method</span><span class="info-value"><%= method || '-' %></span></div>
              <% if (r.type === 'DEPOSIT') { %>
                <div class="info-line"><span class="info-label">Bank name</span><span class="info-value"><%= payerBankName || '-' %></span></div>
                <div class="info-line"><span class="info-label">Account holder name</span><span class="info-value"><%= payer.holderName || '-' %></span></div>
                <% if (method === 'OSKO') { %>
                  <div class="info-line"><span class="info-label">Account number</span><span class="info-value"><%= payer.accountNo || '-' %></span></div>
                  <div class="info-line"><span class="info-label">BSB</span><span class="info-value"><%= payer.bsb || '-' %></span></div>
                <% } else if (method === 'PAYID') { %>
                  <div class="info-line"><span class="info-label">PayID</span><span class="info-value"><%= payer.payIdValue || '-' %></span></div>
                <% } %>
                <% if (r.receiptFile) { %>
                  <div class="info-line"><span class="info-label">Receipt</span><span class="info-value"><a href="<%= r.receiptFile.path %>" target="_blank" rel="noopener">View receipt</a></span></div>
                <% } %>
              <% } else { %>
                <div class="info-line"><span class="info-label">Account holder name</span><span class="info-value"><%= destination.holderName || '-' %></span></div>
                <% if (method === 'OSKO') { %>
                  <div class="info-line"><span class="info-label">Account number</span><span class="info-value"><%= destination.accountNo || '-' %></span></div>
                  <div class="info-line"><span class="info-label">BSB</span><span class="info-value"><%= destination.bsb || '-' %></span></div>
                <% } else if (method === 'PAYID') { %>
                  <div class="info-line"><span class="info-label">PayID</span><span class="info-value"><%= destination.payIdValue || '-' %></span></div>
                <% } %>
              <% } %>
            </div>
          </td>
          <td data-col="comment"><%= r.notes || r.rejectedReason || '-' %></td>
          <td data-col="admin"><%= (r.processedByAdmin && (r.processedByAdmin.displayName || r.processedByAdmin.email)) || '-' %></td>
        </tr>
      <% }) %>
    </tbody>
  </table>
</div>

<div class="pagination">
  <% let sp = new URLSearchParams(query); %>
  <% if (table.page>1) { sp.set('page', String(table.page-1)); %>
    <a href="?<%= sp.toString() %>">&larr; Prev</a>
  <% } else { %><span>Prev</span><% } %>
  <span>Showing <%= table.items.length %> / <%= table.total %> • Page <%= table.page %> / <%= table.pages %></span>
  <% if (table.page<table.pages) { sp.set('page', String(table.page+1)); %>
    <a href="?<%= sp.toString() %>">Next &rarr;</a>
  <% } else { %><span>Next</span><% } %>
</div>

<% if (typeof checkoutToken !== 'undefined') { %>
  <script>
    window.CHECKOUT_TOKEN = "<%- checkoutToken %>";
  </script>
  <script src="/public/checkout/checkout-widget.js?v=2"></script>
  <script src="/public/merchant/merchant.js" defer></script>
  <script>
    (async () => {
      try {
        if (window.PayX && window.CHECKOUT_TOKEN) {
          await PayX.init({
            token: window.CHECKOUT_TOKEN,
            theme: (document.cookie.match(/merchant_theme=(dark)/)?.[1] || "light"),
            onKycApproved:  () => document.getElementById('payx-demo-log').textContent = "KYC approved",
            onKycRejected:  () => document.getElementById('payx-demo-log').textContent = "KYC rejected",
            onDepositSubmitted:    info => document.getElementById('payx-demo-log').textContent = `Deposit ${info.referenceCode}`,
            onWithdrawalSubmitted: info => document.getElementById('payx-demo-log').textContent = `Withdrawal ${info.referenceCode}`,
            onError: err => document.getElementById('payx-demo-log').textContent = "Error: " + (err && (err.error || err.message) || String(err)),
          });
          document.getElementById('payx-open-dep')?.addEventListener('click', () => PayX.openDeposit());
          document.getElementById('payx-open-wdr')?.addEventListener('click', () => PayX.openWithdrawal());
        }
      } catch {}
    })();
  </script>
<% } %>
