<% layout('merchant/layout') -%>

<form class="card filters" method="GET" action="">
  <div class="filters-grid grid-3">
    <div class="f-item">
      <label>Search</label>
      <input type="text" name="q" value="<%= query.q || '' %>" placeholder="Name / email / phone / user ID">
    </div>
    <div class="f-item">
      <label>&nbsp;</label>
      <button type="submit" class="btn primary">Apply</button>
    </div>
  </div>
</form>

<%- include('../partials/column-settings', {
  key: 'merchant.columns.users',
  defaults: { userId:true, fullName:true, email:true, phone:true, status:true, registered:true, lastActivity:true },
  labelMap: { registered: 'Date registered', lastActivity: 'Last activity', externalId: 'External ID', didit: 'Didit subject' },
  columnHeading: 'CLIENT COLUMN SETTINGS'
}) %>

<div class="table-wrap">
  <% const qp = new URLSearchParams(query); %>
  <div class="row" style="justify-content:flex-end; gap:8px; margin-bottom:8px;">
    <a class="btn small" href="/merchant/export/users.csv?<%= qp.toString() %>">Export CSV</a>
    <a class="btn small" href="/merchant/export/users.xlsx?<%= qp.toString() %>">Export XLSX</a>
    <a class="btn small" href="/merchant/export/users.pdf?<%= qp.toString() %>">Export PDF</a>
  </div>

  <table class="table">
    <thead>
      <tr>
        <th data-col="externalId">EXTERNAL ID</th>
        <th data-col="userId">USER ID</th>
        <th data-col="fullName">FULL NAME</th>
        <th data-col="email">EMAIL</th>
        <th data-col="phone">PHONE</th>
        <th data-col="status">VERIFICATION STATUS</th>
        <th data-col="registered">DATE REGISTERED</th>
        <th data-col="lastActivity">LAST ACTIVITY</th>
        <th data-col="didit">DIDIT SUBJECT</th>
      </tr>
    </thead>
    <tbody>
      <% if (!table.items.length) { %>
        <tr><td colspan="9" style="text-align:center;color:var(--ink-dim)">No clients found</td></tr>
      <% } %>
      <% table.items.forEach(user => { %>
        <tr>
          <td data-col="externalId"><span class="mono"><%= user.externalId || '—' %></span></td>
          <td data-col="userId"><span class="mono"><%= user.publicId %></span></td>
          <td data-col="fullName"><%= user.fullName || '—' %></td>
          <td data-col="email"><%= user.email || '—' %></td>
          <td data-col="phone"><%= user.phone || '—' %></td>
          <td data-col="status"><span class="badge <%= user.verificationStatus === 'Verified' ? 'success' : 'warn' %>"><%= user.verificationStatus %></span></td>
          <td data-col="registered"><%- renderDateTime(user.registeredAt) %></td>
          <td data-col="lastActivity"><%- user.lastActivityAt ? renderDateTime(user.lastActivityAt) : '-' %></td>
          <td data-col="didit"><span class="mono"><%= user.diditSubject %></span></td>
        </tr>
      <% }) %>
    </tbody>
  </table>
</div>

<div class="pagination">
  <% const pager = new URLSearchParams(query); %>
  <% if (table.page > 1) { pager.set('page', String(table.page - 1)); %>
    <a href="?<%= pager.toString() %>">&larr; Prev</a>
  <% } else { %>
    <span>Prev</span>
  <% } %>
  <span>Showing <%= table.items.length %> / <%= table.total %> • Page <%= table.page %> / <%= table.pages %></span>
  <% if (table.page < table.pages) { pager.set('page', String(table.page + 1)); %>
    <a href="?<%= pager.toString() %>">Next &rarr;</a>
  <% } else { %>
    <span>Next</span>
  <% } %>
</div>
