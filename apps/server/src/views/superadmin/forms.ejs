<% layout('superadmin/layout') -%>

<!-- status banners (non-intrusive) -->
<% if (error) { %>
  <div class="callout callout-danger">
    <strong>⚠️ Error:</strong> <%= error %>
  </div>
<% } %>
<% if (copied) { %>
  <div class="callout callout-success">
    <strong>✅ Copied.</strong> Source: <em><%= copiedFromLabel %></em>. Review below and Save to confirm.
  </div>
<% } %>
<% if (!banks.length) { %>
  <div class="callout callout-warn">
    Configure a bank account for this merchant before editing forms.
  </div>
<% } %>

<!-- COPY PANEL (separate form, no nesting) -->
<div class="panel copy-panel">
  <form id="copyForm" method="post" action="/superadmin/forms/<%= current || '' %>/copy-from" class="copy-grid">
    <div class="field-col">
      <div class="muted lbl">Copy from merchant</div>
      <select id="copyFromMerchant" class="sel-merch">
        <% merchants.forEach(m => { %>
          <option value="<%= m.id %>" <%= (current===m.id)?'selected':'' %>><%= m.name %></option>
        <% }) %>
      </select>
    </div>

    <div class="field-col">
      <div class="muted lbl">Copy from their bank</div>
      <select id="copyFromBank" class="sel-bank">
        <option value="" disabled selected>Select bank</option>
      </select>
    </div>

    <div class="field-col actions">
      <button class="btn tone-success" type="submit" onclick="return confirm('This will OVERWRITE the current form for this target selection. Continue?')">Copy here</button>
    </div>

    <div class="muted note">
      Target is the selection in the top bar below (Merchant + Bank).
    </div>

    <input type="hidden" name="fromMerchantId" id="copyFromMerchantInput" />
    <input type="hidden" name="fromBankAccountId" id="copyFromBankInput" />
    <input type="hidden" name="toBankAccountId" id="copyToBankInput" />
  </form>
</div>

<form id="forms-editor" method="post" action="/superadmin/forms/<%= current || (merchants[0] && merchants[0].id) || '' %>">
  <input type="hidden" name="depositJson" id="depositJson"/>
  <input type="hidden" name="withdrawalJson" id="withdrawalJson"/>
  <!-- carry bank scope when saving -->
  <input type="hidden" name="bankAccountId" id="bankIdInput" value="<%= currentBank || '' %>"/>

  <!-- Top bar: merchant + bank -->
  <div class="panel">
    <div class="target-grid">
      <label class="form-line">
        <span class="muted lab">Merchant</span>
        <select id="merchantSel" name="merchantId" class="sel-merch">
          <% merchants.forEach(m => { %>
            <option value="<%= m.id %>" <%= (current===m.id)?'selected':'' %>><%= m.name %></option>
          <% }) %>
        </select>
      </label>

      <label class="form-line">
        <span class="muted lab">Bank</span>
        <select id="bankSel" class="sel-bank" <%= (banks && banks.length) ? '' : 'disabled' %>>
          <% if (!(banks || []).length) { %>
            <option value="" selected disabled>No banks configured</option>
          <% } %>
          <% (banks || []).forEach(b => { %>
            <option value="<%= b.id %>" <%= (currentBank===b.id)?'selected':'' %>>
              <%= (b.label || (b.bankName + ' • ' + String(b.accountNo||'').slice(-4))) + ' — ' + (b.method || '').toUpperCase() %>
            </option>
          <% }) %>
        </select>
      </label>
    </div>
  </div>

  <!-- Two columns -->
  <div class="row" style="gap:16px; align-items:flex-start; display:flex; flex-wrap:wrap;">
    <div class="panel col">
      <h3>DEPOSIT FIELDS</h3>
      <div id="depList" class="field-list"></div>
      <button class="btn small" type="button" id="addDep">＋ Add field</button>
    </div>

    <div class="panel col">
      <h3>WITHDRAWAL FIELDS</h3>
      <div id="wdrList" class="field-list"></div>
      <button class="btn small" type="button" id="addWdr">＋ Add field</button>
    </div>
  </div>

  <!-- Save -->
  <div class="panel save-panel">
    <button class="btn tone-primary" type="submit">SAVE</button>
  </div>
</form>

<style>
  /* --- New layout helpers for the copy bar and top bar --- */
  .copy-panel { padding-top:14px; padding-bottom:14px; }
  .copy-grid{
    display:grid;
    grid-template-columns: auto auto auto 1fr;
    column-gap:16px;
    row-gap:6px;
    align-items:end;
  }
  .copy-grid .field-col{ padding:4px 0; }
  .copy-grid .lbl{ margin-bottom:4px; }
  .copy-grid .actions{ display:flex; align-items:end; }
  .copy-grid .note{ margin-left:auto; align-self:center; }

  .target-grid{
    display:grid;
    grid-template-columns: repeat(2, minmax(320px, 1fr));
    gap:16px;
    align-items:end;
  }
  .form-line{
    display:grid;
    grid-template-columns: 96px auto; /* label width => inputs start at same x */
    gap:8px;
    align-items:center;
  }
  .form-line .lab{ text-align:left; padding-top:2px; }

  /* Cap the select widths so they aren't comically long */
  .sel-merch{ width:260px; max-width:260px; }
  .sel-bank{  width:360px; max-width:360px; }

  /* Center the save button with some breathing room */
  .save-panel{ display:flex; justify-content:center; margin-top:12px; }

  .copy-grid .lbl,
  .copy-grid .note,
  .form-line .lab {
    font-size: var(--fs-12);
    opacity: .78;
  }

  /* --- Existing styles (unchanged) --- */
  .col{ flex:1; min-width:360px; }
  .field-card{
    border:1px solid var(--border);
    border-radius:12px;
    padding:20px;
    margin:22px 0;
    background:var(--surface);
    position:relative;
  }
  .grid{ display:grid; grid-template-columns: 160px 1fr; gap:14px; align-items:center; }
  .full { grid-column: 1 / -1; }
  .digits-wrap{ display:none; flex-direction:column; gap:6px; margin-top:8px; }
  .digits-row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .digits-input{ width:140px; }
  .digits-help{ font-size: var(--fs-12); opacity:.78; }
  .digits-error{ font-size: var(--fs-12); color: var(--tone-danger); display:none; }
  .field-card > .grid{ margin-bottom:16px; }
  .field-card > .grid:last-child{ margin-bottom:0; }
  .block-actions{ position:static; display:flex; gap:8px; }
  .icon-mini{
    padding:4px 8px; border:1px solid var(--border);
    background:var(--surface);
    border-radius:6px; cursor:pointer; line-height:1;
    color: var(--ink-dim);
  }
  .icon-mini:hover{ background:var(--ghost); }
  .data-row{ display:grid; grid-template-columns: 1fr auto; gap:8px; margin-bottom:6px; }
  .opt-actions{ display:flex; gap:6px; }
  .drag{ opacity:.6 }
  .data-actions{ display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; }
  .bulk-wrap{ margin-top:10px; padding:10px; border:1px dashed var(--border); border-radius:8px; display:none; flex-direction:column; gap:8px; background:color-mix(in oklab, var(--surface) 92%, transparent); }
  .bulk-wrap textarea{ width:100%; min-height:120px; }
  .bulk-help{ font-size: var(--fs-12); opacity:.78; }
  .bulk-error{ font-size: var(--fs-12); color: var(--tone-danger); }

  .toggle {
    position: relative; display: inline-flex; align-items: center;
    width: 56px; height: 28px; border-radius: 999px;
    border: 1px solid var(--border);
    background: color-mix(in oklab, var(--surface-elevated) 92%, var(--surface));
    cursor: pointer; user-select: none;
    transition: background .18s ease, border-color .18s ease;
  }
  .toggle-input { display: none; }
  .toggle-knob {
    position: absolute; top: 3px; bottom: 3px; left: 3px; right: calc(50% + 3px);
    border-radius: 999px; display: flex; align-items: center; justify-content: center;
    font-size: 11px; font-weight:600; letter-spacing:.2px;
    transition: all .18s ease; background: var(--card); color: var(--ink);
    border:1px solid var(--border); box-shadow: 0 1px 2px rgba(15,23,42,.08);
  }
  .toggle.on {
    background: color-mix(in srgb, var(--tone-info) 20%, transparent);
    border-color: color-mix(in oklab, var(--tone-info) 55%, var(--border));
  }
  .toggle.on .toggle-knob {
    left: calc(50% + 3px); right: 3px;
    background: var(--tone-info);
    color: #fff;
    border-color: color-mix(in oklab, var(--tone-info) 75%, #0f172a);
  }
  .req-wrap{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
  @media (max-width: 980px){
    .grid{ grid-template-columns: 1fr; }
    .req-wrap{ justify-content:flex-start; gap:10px; }
    .sel-merch, .sel-bank { width:100%; max-width:100%; }
    .target-grid{ grid-template-columns: 1fr; }
    .form-line{ grid-template-columns: 96px 1fr; }
  }
</style>

<script>
(function(){
  const cfg = <%- JSON.stringify(config || {deposit:[],withdrawal:[]}) %>;
  const currentMerchant = "<%= current || '' %>";
  const currentBank = "<%= currentBank || '' %>";

  const merchantSel = document.getElementById('merchantSel');
  const bankSel = document.getElementById('bankSel');
  const bankIdInput = document.getElementById('bankIdInput');

  // COPY PANEL elements
  const copyFromMerchant = document.getElementById('copyFromMerchant');
  const copyFromBank = document.getElementById('copyFromBank');
  const copyFromMerchantInput = document.getElementById('copyFromMerchantInput');
  const copyFromBankInput = document.getElementById('copyFromBankInput');
  const copyToBankInput = document.getElementById('copyToBankInput');
  const copyForm = document.getElementById('copyForm');

  async function loadSourceBanks(mid){
    try{
      copyFromBank.innerHTML = '<option value="" disabled selected>Select bank</option>';
      if (!mid) return;
      const res = await fetch('/superadmin/forms/banks.json?merchantId=' + encodeURIComponent(mid), { credentials: 'same-origin' });
      const json = await res.json();
      if (json && json.ok && Array.isArray(json.banks)) {
        json.banks.forEach(b => {
          const label = (b.label || ('Bank • ' + (b.method || '')));
          const opt = document.createElement('option');
          opt.value = b.id;
          opt.textContent = label + (b.active ? '' : ' [inactive]');
          copyFromBank.appendChild(opt);
        });
      }
    } catch(e) {}
  }

  // init copy list with current merchant
  loadSourceBanks(copyFromMerchant.value);

  copyFromMerchant.addEventListener('change', ()=>{
    loadSourceBanks(copyFromMerchant.value);
  });

  // keep copy target in sync with current bank selection
  copyToBankInput.value = currentBank || "";

  copyForm.addEventListener('submit', (e)=>{
    if (!copyFromBank.value) {
      e.preventDefault();
      alert('Select a source bank');
      return;
    }
    if (!document.getElementById('bankSel').value) {
      e.preventDefault();
      alert('Select a target bank');
      return;
    }
    copyFromMerchantInput.value = copyFromMerchant.value;
    copyFromBankInput.value = copyFromBank.value;
    copyToBankInput.value = (document.getElementById('bankSel').value || "");
  });

  // navigation for target selection
  merchantSel.addEventListener('change', ()=>{
    // when merchant changes, reset bank to default
    location.href = '/superadmin/forms?merchantId=' + encodeURIComponent(merchantSel.value);
  });
  bankSel.addEventListener('change', ()=>{
    const qp = new URLSearchParams({ merchantId: merchantSel.value });
    if (bankSel.value) qp.set('bankAccountId', bankSel.value);
    location.href = '/superadmin/forms?' + qp.toString();
  });

  // existing editor
  const depList = document.getElementById('depList');
  const wdrList = document.getElementById('wdrList');
  const addDep = document.getElementById('addDep');
  const addWdr = document.getElementById('addWdr');

  const modes = [['input','Input'],['file','File'],['select','Select']];

  function normalizeRow(r){
    if (!r) return { name:"", display:"input", field:"text", placeholder:"", required:false, minDigits:0, maxDigits:null, options:[] };
    const name = String(r.name ?? r.key ?? r.label ?? "").trim();
    const displayRaw = String(r.display ?? r.mode ?? "input").toLowerCase();
    const display = (displayRaw==="file"||displayRaw==="select") ? displayRaw : "input";

    // support: text | number | phone | email | phone_email
    let field = null;
    if (display==="input"){
      const f = String(r.field ?? "text").toLowerCase();
      field = (["text","number","phone","email","phone_email"].includes(f)) ? f : "text";
    }

    let options = [];
    if (Array.isArray(r.options)) options = r.options.map(String);
    else if (typeof r.data === "string") options = r.data.split(",").map(s=>s.trim()).filter(Boolean);

    let minDigits = 0;
    let maxDigits = null;
    if (display==='input' && field==='number'){
      const minRaw = Number(r.minDigits);
      const maxRaw = r.maxDigits;
      minDigits = Number.isFinite(minRaw) ? Math.max(0, Math.min(64, Math.floor(minRaw))) : 0;
      if (maxRaw === null || typeof maxRaw === 'undefined' || maxRaw === ''){
        maxDigits = null;
      } else {
        const parsed = Number(maxRaw);
        if (Number.isFinite(parsed)){
          maxDigits = Math.max(minDigits, Math.min(64, Math.floor(parsed)));
        }
      }
      const legacy = Number(r.digits);
      if (Number.isFinite(legacy) && legacy > 0){
        minDigits = 0;
        maxDigits = Math.max(minDigits, Math.min(64, Math.floor(legacy)));
      }
    }

    return { name, display, field, placeholder: r.placeholder ?? "", required: !!r.required, minDigits, maxDigits, options };
  }

  function el(tag, attrs={}, children){
    const e = document.createElement(tag);
    for (const [k,v] of Object.entries(attrs||{})){
      if (k==='class') e.className = v;
      else if (k==='style') e.setAttribute('style', v);
      else if (k.startsWith('on') && typeof v==='function') e.addEventListener(k.slice(2), v);
      else e.setAttribute(k,v);
    }
    (Array.isArray(children)?children:[children]).forEach(c=>{
      if (c==null) return;
      if (typeof c === 'string') e.appendChild(document.createTextNode(c));
      else e.appendChild(c);
    });
    return e;
  }
  function wrap(label, node){ return el('div',{class:'grid'},[ el('div',{class:'muted'},label), node ]); }
  function optionRow(listEl, value, afterNode){
    // Render a single select option row. If afterNode is provided, insert the
    // new row immediately after it; otherwise append to the end. This keeps
    // per-row "+" buttons inserting in-place instead of always at the bottom.
    const r = el('div',{class:'data-row'},[
      el('input',{type:'text', class:'i-opt', value:value||'', placeholder:'Option value'}),
      el('div',{class:'opt-actions'},[
        el('button',{type:'button', class:'icon-mini', onclick:()=>{ optionRow(listEl, '', r); }},'＋'),
        el('button',{type:'button', class:'icon-mini', onclick:()=>{ const all=listEl.querySelectorAll('.data-row'); if(all.length>1) r.remove(); else r.querySelector('input').value=''; }},'－')
      ])
    ]);
    if (afterNode && afterNode.parentElement === listEl){
      afterNode.insertAdjacentElement('afterend', r);
    } else {
      listEl.appendChild(r);
    }
    return r;
  }

  function makeToggle(initial){
    const input = el('input',{type:'checkbox', class:'i-required toggle-input'});
    input.checked = !!initial;
    const knob = el('span',{class:'toggle-knob'});
    const shell = el('label',{class:'toggle'},[input, knob]);
    function sync(){
      shell.classList.toggle('on', input.checked);
      knob.textContent = input.checked ? 'ON' : 'OFF';
    }
    input.addEventListener('change', sync);
    sync();
    return { root: shell, input };
  }

  function makeCard(kind, data){
    const d = normalizeRow(data);
    const card = el('div',{class:'field-card', draggable:'true'});

    const actions = el('div',{class:'block-actions'},[
      el('button',{type:'button', class:'icon-mini', onclick:()=>{ const clone = makeCard(kind,{display:'input',field:'text',required:true}); card.parentElement.insertBefore(clone, card.nextSibling); clone.querySelector('.i-name').focus(); refreshSaveState(); }},'＋'),
      el('button',{type:'button', class:'icon-mini', onclick:()=>{ const list=card.parentElement; if(list.querySelectorAll('.field-card').length>1) { card.remove(); refreshSaveState(); } }},'－')
    ]);

    const name = el('input',{type:'text', class:'i-name', value:d.name||'', placeholder:'Field name'});
    const display = el('select',{class:'i-display'});
    modes.forEach(([v,t])=> display.appendChild(new Option(t,v, false, d.display===v)));
    const field = el('select',{class:'i-field'});
    const digitsError = el('div',{class:'digits-error'});
    const minInput = el('input',{type:'number', min:'0', max:'64', step:'1', class:'digits-input i-min-digits', value: Number.isFinite(d.minDigits) ? d.minDigits : 0});
    const maxInput = el('input',{type:'number', min:'0', max:'64', step:'1', class:'digits-input i-max-digits', value: d.maxDigits == null ? '' : d.maxDigits, placeholder:'Unlimited'});
    const digitsWrap = el('div',{class:'digits-wrap'},[
      el('div',{class:'digits-row'},[
        el('label',{},['Min digits', minInput]),
        el('label',{},['Max digits', maxInput])
      ]),
      el('div',{class:'digits-help'},'Accepted length must be between Min and Max digits (inclusive). Leave Max empty for unlimited.'),
      digitsError
    ]);
    const fieldRow = el('div',{class:'grid'},[
      el('div',{class:'muted'},'Field:'),
      el('div',{},[field, digitsWrap])
    ]);
    const placeholder = el('input',{type:'text', class:'i-placeholder', value:d.placeholder||'', placeholder:'Placeholder'});

    const req = makeToggle(d.required);
    const reqRow = el('div',{class:'grid'},[
      el('div',{class:'muted'},'Required field?'),
      el('div',{class:'req-wrap'},[req.root, actions])
    ]);

    const dataList = el('div',{class:'i-data-list'});
    const bulkInput = el('textarea',{placeholder:'One per line or comma separated'});
    const bulkError = el('div',{class:'bulk-error'});
    const bulkWrap = el('div',{class:'bulk-wrap'},[
      el('div',{},'Paste options (one per line or comma-separated)'),
      bulkInput,
      el('div',{class:'bulk-help'},'You can paste from Excel/Sheets columns or CSV. Empty values are ignored.'),
      bulkError,
      el('div',{class:'data-actions'},[
        el('button',{type:'button', class:'btn small tone-primary', onclick:()=>{
          const raw = String(bulkInput.value || '');
          // Support newline and comma separated lists; ignore empty values.
          const values = raw.split(/\n/).flatMap(line => line.split(',')).map(v => v.trim()).filter(Boolean);
          if (!values.length){
            bulkError.textContent = 'No options found in pasted text.';
            return;
          }
          const lastRow = dataList.querySelector('.data-row:last-child');
          values.forEach((val, idx)=>{
            optionRow(dataList, val, idx === 0 ? lastRow : dataList.querySelector('.data-row:last-child'));
          });
          bulkInput.value = '';
          bulkError.textContent = '';
          bulkWrap.style.display = 'none';
        }},'Add options'),
        el('button',{type:'button', class:'btn small', onclick:()=>{ bulkWrap.style.display='none'; bulkError.textContent=''; }},'Cancel')
      ])
    ]);
    const dataWrap = el('div',{class:'grid full i-data-wrap'},[
      el('div',{class:'muted'},'Data'),
      el('div',{},[
        dataList,
        el('div',{class:'data-actions'},[
          el('button',{type:'button', class:'icon-mini', onclick:(e)=>{e.preventDefault(); optionRow(dataList,''); }},'＋ Add option'),
          el('button',{type:'button', class:'icon-mini', onclick:()=>{ const hidden = !bulkWrap.style.display || bulkWrap.style.display === 'none'; bulkWrap.style.display = hidden ? 'flex' : 'none'; if (hidden) bulkInput.focus(); }},'Bulk add')
        ]),
        bulkWrap
      ])
    ]);

    card.appendChild(wrap('Field name', name));
    card.appendChild(wrap('Display mode', display));
    card.appendChild(fieldRow);
    card.appendChild(wrap('Placeholder', placeholder));
    card.appendChild(reqRow);
    card.appendChild(dataWrap);

    function sanitizeDigits(input){
      const raw = String(input.value || '').trim();
      if (raw === '') {
        input.value = '';
        return null;
      }
      const num = Math.floor(Math.max(0, Number(raw)));
      if (!Number.isFinite(num)) {
        input.value = '';
        return null;
      }
      const clamped = Math.min(num, 64);
      if (String(clamped) !== input.value) input.value = String(clamped);
      return clamped;
    }

    function syncDigitsState(){
      const active = display.value==='input' && field.value==='number';
      digitsWrap.style.display = active ? 'flex' : 'none';
      if (!active){
        digitsError.textContent = '';
        digitsError.style.display = 'none';
        card.removeAttribute('data-digit-error');
        refreshSaveState();
        return;
      }
      const minVal = sanitizeDigits(minInput) ?? 0;
      const maxValRaw = sanitizeDigits(maxInput);
      const maxVal = maxInput.value === '' ? null : (maxValRaw ?? minVal);
      let message = '';
      if (minVal < 0){
        message = 'Min digits must be 0 or greater.';
      } else if (maxVal !== null && maxVal < minVal){
        message = 'Max digits must be greater than or equal to Min digits.';
      }
      if (message){
        digitsError.textContent = message;
        digitsError.style.display = 'block';
        card.setAttribute('data-digit-error','1');
      } else {
        digitsError.textContent = '';
        digitsError.style.display = 'none';
        card.removeAttribute('data-digit-error');
      }
      refreshSaveState();
    }

    function syncByDisplay(){
      const mode = display.value;
      field.innerHTML = '';
      if (mode==='input'){
        field.disabled = false;
        // NEW choices
        const opts = [
          ['text','text'],
          ['number','number'],
          ['phone','phone number'],
          ['email','email'],
          ['phone_email','phone or email']
        ];
        opts.forEach(([v,t]) => field.appendChild(new Option(t, v)));
        field.value = (d.field && opts.some(o=>o[0]===d.field)) ? d.field : 'text';
        syncDigitsState();
        dataWrap.style.display = 'none';
      } else if (mode==='file'){
        field.appendChild(new Option('null','null'));
        field.value = 'null'; field.disabled = true;
        syncDigitsState();
        dataWrap.style.display = 'none';
      } else { // select
        field.appendChild(new Option('null','null'));
        field.value = 'null'; field.disabled = true;
        syncDigitsState();
        dataWrap.style.display = '';
        const list = card.querySelector('.i-data-list');
        if (!list.children.length) optionRow(list,'');
      }
    }
    display.addEventListener('change', syncByDisplay);
    field.addEventListener('change', syncDigitsState);
    [minInput, maxInput].forEach(inp => {
      inp.addEventListener('input', syncDigitsState);
      inp.addEventListener('change', syncDigitsState);
      inp.addEventListener('blur', syncDigitsState);
    });

    // init
    syncByDisplay();
    syncDigitsState();
    if (d.display==='select'){
      const list = card.querySelector('.i-data-list');
      list.innerHTML = '';
      (d.options||[]).forEach(v=> optionRow(list,v));
      if (!(d.options||[]).length) optionRow(list,'');
    }

    // drag re-order
    card.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain','drag'); card.classList.add('drag'); });
    card.addEventListener('dragend', ()=> card.classList.remove('drag'));
    card.addEventListener('dragover', e=>{
      e.preventDefault();
      const list = card.parentElement;
      const dragging = list.querySelector('.field-card.drag');
      if (!dragging || dragging===card) return;
      const rect = card.getBoundingClientRect();
      const before = (e.clientY - rect.top) < rect.height/2;
      list.insertBefore(dragging, before ? card : card.nextSibling);
    });

    return card;
  }

  function refreshSaveState(){
    const saveBtn = document.querySelector('.save-panel button[type="submit"]');
    if (!saveBtn) return;
    const invalid = document.querySelector('.field-card[data-digit-error="1"]');
    saveBtn.disabled = !!invalid;
  }

  function load(){
    depList.innerHTML = ''; wdrList.innerHTML = '';
    (cfg.deposit||[]).map(normalizeRow).forEach(x=> depList.appendChild(makeCard('deposit', x)));
    (cfg.withdrawal||[]).map(normalizeRow).forEach(x=> wdrList.appendChild(makeCard('withdrawal', x)));
    if (!depList.children.length) depList.appendChild(makeCard('deposit', {display:'input', field:'text', required:true}));
    if (!wdrList.children.length) wdrList.appendChild(makeCard('withdrawal', {display:'input', field:'text', required:true}));
    refreshSaveState();
  }
  addDep.addEventListener('click', ()=> { depList.appendChild(makeCard('deposit', {display:'input', field:'text', required:true})); refreshSaveState(); });
  addWdr.addEventListener('click', ()=> { wdrList.appendChild(makeCard('withdrawal', {display:'input', field:'text', required:true})); refreshSaveState(); });
  load();

  // Pack JSON and include the bank scope; skip blank-name rows to avoid server-side validation errors
  document.getElementById('forms-editor').addEventListener('submit', ()=>{
    function pack(list){
      const rows = [];
      list.querySelectorAll('.field-card').forEach(card=>{
        const name = card.querySelector('.i-name').value.trim();
        if (!name) return; // IMPORTANT: drop unfinished rows
        const display = card.querySelector('.i-display').value;
        const fieldSel = card.querySelector('.i-field').value;
        const placeholder = card.querySelector('.i-placeholder').value;
        const required = card.querySelector('.i-required').checked;
        const minDigitsInput = card.querySelector('.i-min-digits');
        const maxDigitsInput = card.querySelector('.i-max-digits');
        const parsedMin = minDigitsInput ? Number(minDigitsInput.value || 0) : 0;
        const minDigits = Number.isFinite(parsedMin) ? Math.max(0, Math.floor(parsedMin)) : 0;
        const rawMax = maxDigitsInput ? String(maxDigitsInput.value || '') : '';
        const parsedMax = rawMax === '' ? NaN : Number(rawMax);
        const maxDigits = rawMax === '' || !Number.isFinite(parsedMax)
          ? null
          : Math.max(minDigits, Math.floor(parsedMax));
        const row = {
          name,
          display,
          // NEW: keep exact selection (text/number/phone/email/phone_email)
          field: display==='input' ? fieldSel : null,
          placeholder,
          required,
          minDigits: (display==='input' && fieldSel==='number') ? minDigits : 0,
          maxDigits: (display==='input' && fieldSel==='number') ? maxDigits : null,
          options: []
        };
        if (display==='select'){
          row.options = Array.from(card.querySelectorAll('.i-opt')).map(i=>i.value.trim()).filter(Boolean);
        }
        rows.push(row);
      });
      return rows;
    }
    bankIdInput.value = bankSel.value || '';
    document.getElementById('depositJson').value = JSON.stringify(pack(depList));
    document.getElementById('withdrawalJson').value = JSON.stringify(pack(wdrList));
  });
})();
</script>