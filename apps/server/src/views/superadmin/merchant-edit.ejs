<% layout('superadmin/layout') -%>

<% if (typeof saved !== 'undefined' && saved) { %>
  <div class="callout callout-success callout-floating">Saved ‚úÖ</div>
<% } %>

<% const policyEnabled = typeof revealPolicyEnabled === 'undefined' ? true : !!revealPolicyEnabled; %>
<% const permissionGranted = typeof adminRevealPermission === 'undefined' ? false : !!adminRevealPermission; %>
<% const allowRevealFlag = typeof allowReveal === 'undefined' ? (policyEnabled && permissionGranted) : !!allowReveal; %>
<% const revealCfg = typeof revealConfig === 'undefined' || !revealConfig ? {} : revealConfig; %>
<% const revealStateData = typeof revealState === 'undefined' || !revealState ? {} : revealState; %>
<% const lastRevealMap = revealStateData.lastRevealed || {}; %>
<% const requireTotp = !!revealStateData.requireTotp; %>
<% const requirePassword = !!revealStateData.requirePassword; %>
<% const stepStorageKey = revealStateData.stepStorage || 'super.keyReveal.step'; %>
<% const autoHideSeconds = Number.isFinite(revealCfg.autoHideSeconds) ? revealCfg.autoHideSeconds : 60; %>
<% const allowRevokedReveal = !!revealCfg.adminCanRevealRevoked; %>

<form method="post" action="<%= merchant ? '/superadmin/merchants/'+merchant.id+'/edit' : '/superadmin/merchants/new' %>" class="card">
  <div class="f-item"><label>Name</label><input name="name" value="<%= merchant?.name||'' %>" required/></div>

  <div class="f-item">
    <label>Email</label>
    <input name="email" type="email" value="<%= merchant?.email||'' %>" placeholder="billing@example.com"/>
  </div>

  <div class="f-item">
    <label>Website / Webhook URL</label>
    <input name="webhookUrl" value="<%= merchant?.webhookUrl||'' %>" placeholder="https://example.com/webhook"/>
  </div>

  <div class="f-item">
    <label for="diditWorkflowId">Didit workflow ID (optional)</label>
    <input
      id="diditWorkflowId"
      name="diditWorkflowId"
      type="text"
      value="<%= merchant?.diditWorkflowId || '' %>"
      autocomplete="off"
    />
    <p class="muted">
      Used for KYC via Didit. If empty, system falls back to global DIDIT_WORKFLOW_ID (for backwards compatibility).
    </p>
  </div>

  <div class="f-item">
    <label>Default currency</label>
    <input name="defaultCurrency" value="<%= merchant?.defaultCurrency||'USD' %>" placeholder="USD"/>
  </div>

  <div class="f-item">
    <label>Status</label>
    <select name="status">
      <option value="active"     <%= merchant?.status==='active'?'selected':'' %>>active</option>
      <option value="suspended"  <%= merchant?.status==='suspended'?'selected':'' %>>suspended</option>
      <option value="closed"     <%= merchant?.status==='closed'?'selected':'' %>>closed</option>
    </select>
  </div>

  <label class="chk" style="margin-top:6px">
    <input type="checkbox" name="active" <%= merchant?.active?'checked':'' %>/> Active
  </label>

  <label class="chk" style="margin-top:6px">
    <input type="checkbox" name="userDirectoryEnabled" <%= merchant?.userDirectoryEnabled?'checked':'' %>/> User directory enabled
  </label>

  <label class="chk" style="margin-top:6px">
    <input type="checkbox" name="apiKeysSelfServiceEnabled" <%= (merchant?.apiKeysSelfServiceEnabled ?? true) ? 'checked' : '' %>/>
    Allow merchant to manage API keys (self-service)
  </label>

  <div class="row" style="margin-top:12px"><button class="btn primary">Save</button></div>
</form>

<% if (merchant) { %>
  <div class="card">
    <div class="title">API rate limits</div>
    <form method="post" action="/superadmin/merchants/<%= merchant.id %>/limits">
      <div class="f-item">
        <label>Max requests per minute</label>
        <input name="maxReqPerMin" type="number" value="<%= merchant?.limits?.maxReqPerMin ?? '' %>" placeholder="leave blank = unlimited"/>
      </div>
      <div class="f-item">
        <label>IP allow list (comma or space separated)</label>
        <input name="ipAllowList" value="<%= (merchant?.limits?.ipAllowList||[]).join(', ') %>"/>
      </div>
      <button class="btn">Save limits</button>
    </form>
  </div>

  <div class="card">
    <div class="title">Telegram channels</div>
    <form method="post" action="/superadmin/merchants/<%= merchant.id %>/notify/add" class="row" style="gap:8px">
      <input type="hidden" name="type" value="TELEGRAM"/>
      <input name="chatId" placeholder="Chat ID" required/>
      <select name="direction">
        <option>BOTH</option>
        <option>INCOMING</option>
        <option>OUTGOING</option>
      </select>
      <button class="btn small">Add</button>
    </form>
    <ul>
      <% (channels||[]).forEach(n => { %>
        <li>
          <code><%= n.type %></code> <%= n.chatId %> (<%= n.direction %>)
          <form method="post" action="/superadmin/merchants/<%= merchant.id %>/notify/<%= n.id %>/delete" style="display:inline">
            <button class="btn small">Remove</button>
          </form>
        </li>
      <% }) %>
      <% if (!channels || channels.length === 0) { %>
        <li style="opacity:.7">No channels yet.</li>
      <% } %>
    </ul>
  </div>

  <% if (newCreds) { %>
  <div class="card tone-success">
    <div class="title">User created</div>
    <p>
      Temporary credentials (shown once):
    </p>
    <div class="row" style="gap:8px; align-items:center;">
      <input readonly value="<%= newCreds.email %>" style="max-width:300px"/>
      <input id="tmp-pass" readonly value="<%= newCreds.password %>" style="max-width:240px"/>
      <button type="button" class="btn small" onclick="
        navigator.clipboard.writeText(document.getElementById('tmp-pass').value)
      ">Copy password</button>
    </div>
    <p style="margin-top:8px;opacity:.8">
      Share with the merchant and ask them to log in at <code>/merchant/login</code> and set a new password & 2FA.
    </p>
  </div>
  <% } %>

  <% if (newApiKey) { %>
  <div class="card tone-success">
    <div class="title">API key created</div>
    <p>This API key is shown <strong>once</strong>. Copy and store it securely:</p>
    <div class="row" style="gap:8px; align-items:center;">
      <input id="api-key-plaintext" readonly value="<%= newApiKey %>" style="flex:1; min-width:280px"/>
      <button type="button" class="btn small" onclick="
        navigator.clipboard.writeText(document.getElementById('api-key-plaintext').value)
      ">Copy</button>
    </div>
  </div>
  <% } %>

  <div class="card">
    <div class="title">API keys</div>

    <% if (!policyEnabled) { %>
      <div class="card" style="margin-bottom:12px; background:var(--row); border-color:rgba(255,168,0,0.4)">
        <div class="muted">API key reveal is disabled by platform policy in this environment.</div>
      </div>
    <% } else if (!permissionGranted) { %>
      <div class="card" style="margin-bottom:12px; background:var(--row); border-color:rgba(248,113,113,0.4)">
        <div class="muted">Your account does not have permission to reveal merchant API keys.</div>
      </div>
    <% } %>

    <form method="post" action="/superadmin/merchants/<%= merchant.id %>/keys/new" class="row" style="gap:8px; flex-wrap:wrap; margin-bottom:10px">
      <input name="label" placeholder="Label (optional)" style="min-width:200px"/>
      <input name="scopes" placeholder="Scopes (csv, e.g. payments:read,payments:write)" style="min-width:360px; flex:1"/>
      <button class="btn small">Create key</button>
    </form>

    <table class="table">
      <thead>
        <tr>
          <th>Key</th>
          <th>Label</th>
          <th>Scopes</th>
          <th>Last used</th>
          <th>Created</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
      <% (apiKeys||[]).forEach(k => {
           const prefix = k.prefix || (k.id ? String(k.id).slice(0,8) : 'key');
           const last4 = k.last4 || '';
           const revoked = (k.active === false);
           const revealAllowed = allowRevealFlag && (allowRevokedReveal || !revoked);
           const lastSeen = lastRevealMap[k.id] || '';
        %>
        <tr style="<%= revoked ? 'opacity:.6' : '' %>">
          <td class="mono">
            <code><%= prefix %>.****<%= last4 %></code>
            <% if (revoked) { %><span class="text-danger" style="margin-left:6px">(revoked)</span><% } %>
          </td>
          <td><%= k.label || '‚Äî' %></td>
          <td class="mini"><%= Array.isArray(k.scopes) ? k.scopes.join(', ') : (k.scopes || '‚Äî') %></td>
          <td class="mini"><%- k.lastUsedAt ? renderDateTime(k.lastUsedAt) : '‚Äî' %></td>
          <td class="mini"><%- k.createdAt ? renderDateTime(k.createdAt) : '‚Äî' %></td>
          <td class="nowrap">
            <button
              type="button"
              class="btn small"
              data-api-key-reveal-trigger
              data-reveal-scope="super"
              data-endpoint="/superadmin/merchants/<%= merchant.id %>/keys/<%= k.id %>/reveal"
              data-key-id="<%= k.id %>"
              data-key-prefix="<%= prefix %>"
              data-key-last4="<%= last4 %>"
              data-last-revealed="<%= lastSeen %>"
              data-allow="<%= revealAllowed ? '1' : '0' %>"
              title="<%= revealAllowed ? 'View key' : 'Reveal unavailable' %>"
              <%= revealAllowed ? '' : 'disabled aria-disabled="true"' %>>
              üëÅ
            </button>
            <% if (!revoked) { %>
            <form method="post" action="/superadmin/merchants/<%= merchant.id %>/keys/<%= k.id %>/revoke" style="display:inline" onsubmit="return confirm('Revoke this API key? This cannot be undone.')">
              <button class="btn small">Revoke</button>
            </form>
            <% } %>
          </td>
        </tr>
      <% }) %>
      <% if (!apiKeys || apiKeys.length === 0) { %>
        <tr><td colspan="6" class="mini" style="opacity:.7">No API keys yet.</td></tr>
      <% } %>
      </tbody>
    </table>
  </div>

  <div class="card">
    <div class="title">Merchant users</div>

    <form method="post" action="/superadmin/merchants/<%= merchant.id %>/users/new?from=edit" class="row" style="gap:8px;flex-wrap:wrap">
      <input name="email" type="email" placeholder="user@merchant.com" required style="min-width:260px"/>
      <select name="role">
        <option value="OWNER">OWNER</option>
        <option value="MANAGER" selected>MANAGER</option>
        <option value="ANALYST">ANALYST</option>
      </select>
      <label class="chk" title="User can log in immediately">
        <input type="checkbox" name="active" checked/> Active
      </label>
      <label class="chk" title="Generate a strong temporary password">
        <input type="checkbox" name="generate" checked/> Auto-generate password
      </label>
      <label class="chk" title="Allow viewing API keys">
        <input type="checkbox" name="canRevealKeys" checked/> API key reveal access
      </label>
      <button class="btn small">Create user</button>
      <a class="btn small" href="/superadmin/merchants/<%= merchant.id %>/users" style="margin-left:auto">Manage users‚Ä¶</a>
    </form>
  </div>

<% } %>

<div
  class="modal-backdrop"
  data-api-key-reveal-modal
  hidden
  data-scope="super"
  data-require-totp="<%= requireTotp ? '1' : '0' %>"
  data-require-password="<%= requirePassword ? '1' : '0' %>"
  data-step-storage="<%= stepStorageKey %>"
  data-auto-hide="<%= autoHideSeconds %>"
>
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="reveal-title">
    <button type="button" class="modal-close" data-reveal-close aria-label="Close">√ó</button>
    <div data-reveal-view="step">
      <h2 class="modal-title" id="reveal-title">Verify before reveal</h2>
      <p class="muted">
        <% if (requireTotp) { %>
          Enter your authenticator code and provide a reason to reveal this key.
        <% } else { %>
          Enter your password and provide a reason to reveal this key.
        <% } %>
      </p>
      <div class="form-field" data-reveal-password-field <%= requireTotp && !requirePassword ? 'hidden' : '' %>>
        <label for="reveal-password">Password</label>
        <input id="reveal-password" type="password" autocomplete="current-password" data-reveal-password />
      </div>
      <div class="form-field" data-reveal-totp-field <%= requireTotp ? '' : 'hidden' %>>
        <label for="reveal-totp">Authenticator code</label>
        <input id="reveal-totp" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="6" autocomplete="one-time-code" data-reveal-totp />
      </div>
      <div class="form-field" data-reveal-reason-field>
        <label for="reveal-reason">Reason</label>
        <textarea id="reveal-reason" rows="3" data-reveal-reason placeholder="Explain why the key is being revealed" required></textarea>
      </div>
      <div class="form-error" data-reveal-error role="alert"></div>
      <div class="row" style="gap:8px; justify-content:flex-end">
        <button type="button" class="btn" data-reveal-cancel>Cancel</button>
        <button type="button" class="btn primary" data-reveal-submit>Continue</button>
      </div>
    </div>
    <div data-reveal-view="result" hidden>
      <h2 class="modal-title">API key revealed</h2>
      <p class="muted">Key: <code data-reveal-key></code></p>
      <div class="secret-box" data-secret-wrapper>
        <code class="secret" data-secret-value>‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</code>
        <button type="button" class="btn small" data-secret-toggle>Show</button>
      </div>
      <div class="row" style="gap:8px; justify-content:flex-end">
        <button type="button" class="btn" data-reveal-done>Close</button>
        <button type="button" class="btn primary" data-secret-copy>Copy</button>
      </div>
      <p class="muted" data-reveal-countdown></p>
      <p class="muted" data-reveal-last></p>
    </div>
  </div>
</div>
