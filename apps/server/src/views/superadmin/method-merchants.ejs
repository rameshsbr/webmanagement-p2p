<% layout('superadmin/layout') -%>

<div class="page methods-assign">
  <div class="card">
    <div class="panel-header">
      <div>
        <h1>Assign merchants â€“ <%= method.name %> (<span class="mono"><%= method.code %></span>)</h1>
        <p class="muted">Select which merchants can use this method. You can tick <strong>Deposit</strong> and/or <strong>Withdrawal</strong> per merchant (server remains backward-compatible and treats either as enabled).</p>
      </div>
      <a class="btn small" href="/superadmin/methods">Back to Methods</a>
    </div>

    <style>
      .methods-assign .table-wrap { max-height: 70vh; overflow: auto; }
      .methods-assign table.table thead th { position: sticky; top: 0; background: var(--paper); z-index: 1; }
      .methods-assign .table tr:hover { background: rgba(0,0,0,0.03); }
      .methods-assign .use-group { display: flex; align-items: center; gap: 10px; }
      .methods-assign .use-col { width: 220px; min-width: 220px; }
      .methods-assign .use-cell { white-space: nowrap; }
      .methods-assign .subtle { color: var(--ink-dim); font-size: 12px; }
      .methods-assign .twocol { display:flex; gap:16px; align-items:center; }
      .methods-assign .checkall { display:flex; gap:14px; align-items:center; }
      .methods-assign .checkall label { display:flex; gap:6px; align-items:center; cursor:pointer; }
      .methods-assign .chip { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid var(--line); font-size:12px; }
    </style>

    <form method="post" action="/superadmin/methods/<%= method.id %>/merchants" data-methods-form="assign">
      <div class="checkall" style="margin-bottom:10px;">
        <span class="subtle">Quick select:</span>
        <label><input type="checkbox" id="checkAllDeposit" /> Deposit (all)</label>
        <label><input type="checkbox" id="checkAllWithdrawal" /> Withdrawal (all)</label>
        <span class="chip">Tip: you can mix & match</span>
      </div>

      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th class="use-col">Use</th>
              <th>Merchant</th>
            </tr>
          </thead>
          <tbody>
            <% if (!merchants.length) { %>
              <tr><td colspan="2" style="text-align:center; color:var(--ink-dim);">No merchants found.</td></tr>
            <% } %>
            <% merchants.forEach((m) => { 
                 const linked = method.merchantLinks?.find((mm) => mm.merchantId === m.id);
                 const precheck = linked ? 'checked' : '';
            %>
              <tr>
                <td class="use-cell">
                  <div class="use-group">
                    <!-- New: two separate arrays posted -->
                    <label class="twocol">
                      <input type="checkbox" class="cb-deposit" name="merchantIdsDeposit[]" value="<%= m.id %>" <%= precheck %> />
                      <span>Deposit</span>
                    </label>
                    <label class="twocol">
                      <input type="checkbox" class="cb-withdrawal" name="merchantIdsWithdrawal[]" value="<%= m.id %>" <%= precheck %> />
                      <span>Withdrawal</span>
                    </label>
                  </div>

                  <!-- Backward-compat: if the server still expects 'merchantIds', we also submit a union via JS (see below). -->
                  <input type="checkbox" class="cb-union" name="merchantIds[]" value="<%= m.id %>" <%= precheck %> style="display:none;" />
                </td>
                <td><%= m.name %></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>

      <div class="form-actions">
        <button class="btn primary" type="submit">Save assignments</button>
        <a class="btn" href="/superadmin/methods">Cancel</a>
      </div>
    </form>

    <script>
      (function () {
        const $ = (sel, root) => (root || document).querySelector(sel);
        const $$ = (sel, root) => Array.from((root || document).querySelectorAll(sel));

        // Keep hidden union checkbox in sync (for servers that still read 'merchantIds')
        function syncUnion() {
          $$(".table tbody tr").forEach((row) => {
            const dep = $(".cb-deposit", row);
            const wdr = $(".cb-withdrawal", row);
            const uni = $(".cb-union", row);
            if (dep && wdr && uni) {
              uni.checked = !!(dep.checked || wdr.checked);
            }
          });
        }

        // Check-all helpers
        const checkAllDeposit = $("#checkAllDeposit");
        const checkAllWithdrawal = $("#checkAllWithdrawal");

        if (checkAllDeposit) {
          checkAllDeposit.addEventListener("change", (e) => {
            const checked = e.target.checked;
            $$(".cb-deposit").forEach((cb) => { cb.checked = checked; });
            syncUnion();
          });
        }
        if (checkAllWithdrawal) {
          checkAllWithdrawal.addEventListener("change", (e) => {
            const checked = e.target.checked;
            $$(".cb-withdrawal").forEach((cb) => { cb.checked = checked; });
            syncUnion();
          });
        }

        // Per-row changes keep union in sync too
        $$(".cb-deposit, .cb-withdrawal").forEach((cb) => {
          cb.addEventListener("change", syncUnion);
        });

        // Initial sync
        syncUnion();
      })();
    </script>
  </div>
</div>