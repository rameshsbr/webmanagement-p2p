<% layout('superadmin/layout') -%>

<%
  const IDR_V4_METHODS = new Set([
    'VIRTUAL_BANK_ACCOUNT_DYNAMIC',
    'VIRTUAL_BANK_ACCOUNT_STATIC',
    'FAZZ_SEND'
  ]);
  const IDR_V4_BANK_METHODS = new Set([
    'VIRTUAL_BANK_ACCOUNT_DYNAMIC',
    'VIRTUAL_BANK_ACCOUNT_STATIC'
  ]);
  function centsToUnits(v) {
    return (typeof v === 'number' && !Number.isNaN(v)) ? (v / 100).toFixed(2) : '';
  }
%>

<div class="page methods-page">
  <div class="page__header">
    <div>
      <h1>Methods</h1>
      <p class="muted">Manage payment methods, assignments, usage, and limits.</p>
    </div>
  </div>

  <div class="card methods-card">
    <form method="post" action="/superadmin/methods" class="methods-add" data-methods-form="create">
      <div class="form-field">
        <label for="method-code">Code</label>
        <input id="method-code" class="input" required name="code" placeholder="OSKO" style="text-transform:uppercase;" />
      </div>
      <div class="form-field">
        <label for="method-name">Name</label>
        <input id="method-name" class="input" required name="name" placeholder="Osko" />
      </div>
      <div class="form-field form-field--inline">
        <label for="method-enabled">Enabled</label>
        <input id="method-enabled" type="checkbox" name="enabled" checked />
      </div>
      <div class="form-field methods-add__actions">
        <button class="btn primary" type="submit">Add method</button>
      </div>
    </form>

    <% if (!methods.length) { %>
      <p class="muted" style="margin: 12px 0;">No methods available yet.</p>
    <% } else { %>
      <div class="methods-grid">
        <% methods.forEach((method) => {
          const stat = stats[method.id] || { merchants: 0, deposits: 0, withdrawals: 0 };
          const formId = `method-form-${method.id}`;
          const modalId = `limits-modal-${method.id}`;
          const banksModalId = `banks-modal-${method.id}`;
          const methodCode = String(method.code || '').trim().toUpperCase();
          const groupLabel = IDR_V4_METHODS.has(methodCode) ? 'IDR v4' : 'P2P';
          const hasIdr = Number(method.minorUnits) === 1;
        %>
          <div class="method-card">
            <form id="<%= formId %>" method="post" action="/superadmin/methods/<%= method.id %>" data-methods-form="row"></form>
            <div class="method-card__header">
              <div class="method-card__title">
                <input class="input method-name" form="<%= formId %>" name="name" value="<%= method.name %>" />
                <div class="method-meta">
                  <span class="mono">Code: <%= method.code %></span>
                  <span class="pill pill--subtle"><%= groupLabel %></span>
                  <% if (methodCode === 'AUD_NPP') { %>
                    <span class="pill pill--subtle">AUD</span>
                    <span class="pill pill--subtle">NPP</span>
                  <% } %>
                  <span class="muted"><%= method.currencyHint %></span>
                </div>
              </div>
              <label class="toggle">
                <input form="<%= formId %>" type="checkbox" name="enabled" <%= method.enabled ? 'checked' : '' %> />
                <span>Enabled</span>
              </label>
            </div>

            <div class="method-card__badges">
              <span class="badge">Merchants <strong><%= stat.merchants %></strong></span>
              <span class="badge">Deposits <strong><%= stat.deposits %></strong></span>
              <span class="badge">Withdrawals <strong><%= stat.withdrawals %></strong></span>
            </div>

            <div class="method-card__actions">
              <a class="btn small" href="/superadmin/methods/<%= method.id %>/merchants">Assign merchants</a>
              <button class="btn small" type="submit" form="<%= formId %>">Save</button>
              <button class="btn small btn-outline" type="button" data-modal-open="<%= modalId %>">LIMITS</button>
              <% if (IDR_V4_BANK_METHODS.has(methodCode)) { %>
                <button class="btn small btn-outline" type="button" data-modal-open="<%= banksModalId %>">BANKS</button>
              <% } %>
            </div>
          </div>

          <div class="modal" id="<%= modalId %>" data-modal>
            <div class="modal__backdrop" data-modal-close="<%= modalId %>"></div>
            <div class="modal__content" role="dialog" aria-modal="true" aria-labelledby="<%= modalId %>-title">
              <div class="modal__header">
                <div>
                  <h2 id="<%= modalId %>-title">Limits – <%= method.name %></h2>
                  <p class="muted">Global defaults for deposits and withdrawals.</p>
                </div>
                <button type="button" class="btn small" data-modal-close="<%= modalId %>">Close</button>
              </div>

              <form method="post" action="/superadmin/methods/<%= method.id %>/limits" class="limits-form" data-limits-form data-idr="<%= hasIdr ? 'true' : 'false' %>">
                <div class="limits-grid">
                  <div class="form-field">
                    <label>Min Deposit</label>
                    <input class="input" inputmode="decimal" name="minDeposit" placeholder="0.00" value="<%= method.displayMinDeposit %>" />
                  </div>
                  <div class="form-field">
                    <label>Max Deposit</label>
                    <input class="input" inputmode="decimal" name="maxDeposit" placeholder="0.00" value="<%= method.displayMaxDeposit %>" />
                  </div>
                  <div class="form-field">
                    <label>Min Withdrawal</label>
                    <input class="input" inputmode="decimal" name="minWithdrawal" placeholder="0.00" value="<%= method.displayMinWithdrawal %>" />
                  </div>
                  <div class="form-field">
                    <label>Max Withdrawal</label>
                    <input class="input" inputmode="decimal" name="maxWithdrawal" placeholder="0.00" value="<%= method.displayMaxWithdrawal %>" />
                  </div>
                </div>

                <p class="muted" style="margin: 4px 0 0;">
                  <% if (hasIdr) { %>
                    IDR limits must be between 10,000 and 100,000,000.
                  <% } else { %>
                    Leave blank to use defaults.
                  <% } %>
                </p>

                <div class="limits-error" aria-live="polite"></div>

                <details class="limits-advanced">
                  <summary>Advanced per-bank overrides</summary>
                  <% if ((method.banks || []).length === 0) { %>
                    <div class="muted" style="font-size: 12px; margin-top: 8px;">No banks configured for this method yet.</div>
                  <% } else { %>
                    <div class="muted" style="font-size: 12px; margin: 8px 0;">
                      Amounts in currency units; leave blank to use defaults.
                    </div>
                    <div class="table-wrap" style="margin:0;">
                      <table class="table" style="margin:0;">
                        <thead>
                          <tr>
                            <th style="width:28%;">Bank</th>
                            <th style="width:8%;">Currency</th>
                            <th>Min Deposit</th>
                            <th>Max Deposit</th>
                            <th>Min Withdrawal</th>
                            <th>Max Withdrawal</th>
                          </tr>
                        </thead>
                        <tbody>
                          <% method.banks.forEach((b) => {
                            const label = b.label || (b.bankName + ' • ' + String(b.accountNo || '').slice(-4));
                          %>
                            <tr>
                              <td>
                                <div class="mono" title="<%= b.id %>"><%= label %></div>
                                <div class="muted" style="font-size:11px;">
                                  <%= b.merchantName ? (b.merchantName + ' • ') : '' %><%= b.active ? 'Active' : 'Inactive' %>
                                </div>
                              </td>
                              <td class="mono"><%= b.currency %></td>
                              <td>
                                <div class="input-with-suffix">
                                  <input
                                    class="input"
                                    inputmode="decimal"
                                    placeholder="0.00"
                                    name="banks[<%= b.id %>][minDeposit]"
                                    value="<%= centsToUnits(b.minDepositCents) %>"
                                  />
                                  <span class="suffix mono"><%= b.currency %></span>
                                </div>
                              </td>
                              <td>
                                <div class="input-with-suffix">
                                  <input
                                    class="input"
                                    inputmode="decimal"
                                    placeholder="0.00"
                                    name="banks[<%= b.id %>][maxDeposit]"
                                    value="<%= centsToUnits(b.maxDepositCents) %>"
                                  />
                                  <span class="suffix mono"><%= b.currency %></span>
                                </div>
                              </td>
                              <td>
                                <div class="input-with-suffix">
                                  <input
                                    class="input"
                                    inputmode="decimal"
                                    placeholder="0.00"
                                    name="banks[<%= b.id %>][minWithdrawal]"
                                    value="<%= centsToUnits(b.minWithdrawalCents) %>"
                                  />
                                  <span class="suffix mono"><%= b.currency %></span>
                                </div>
                              </td>
                              <td>
                                <div class="input-with-suffix">
                                  <input
                                    class="input"
                                    inputmode="decimal"
                                    placeholder="0.00"
                                    name="banks[<%= b.id %>][maxWithdrawal]"
                                    value="<%= centsToUnits(b.maxWithdrawalCents) %>"
                                  />
                                  <span class="suffix mono"><%= b.currency %></span>
                                </div>
                              </td>
                            </tr>
                          <% }) %>
                        </tbody>
                      </table>
                    </div>
                  <% } %>
                </details>

                <div class="modal__actions">
                  <button class="btn primary" type="submit">Save limits</button>
                </div>
              </form>
            </div>
          </div>

          <% if (IDR_V4_BANK_METHODS.has(methodCode)) { %>
            <div class="modal" id="<%= banksModalId %>" data-modal>
              <div class="modal__backdrop" data-modal-close="<%= banksModalId %>"></div>
              <div class="modal__content" role="dialog" aria-modal="true" aria-labelledby="<%= banksModalId %>-title">
                <div class="modal__header">
                  <div>
                    <h2 id="<%= banksModalId %>-title">Banks – <%= method.name %></h2>
                    <p class="muted">Manage bank codes for IDR v4 VA methods.</p>
                  </div>
                  <button type="button" class="btn small" data-modal-close="<%= banksModalId %>">Close</button>
                </div>

                <form method="post" action="/superadmin/methods/<%= method.id %>/banks" class="banks-form" data-methods-form="banks" data-banks-form>
                  <div class="table-wrap banks-table">
                    <table class="table">
                      <thead>
                        <tr>
                          <th style="width:28%;">Bank code</th>
                          <th>Display name</th>
                          <th style="width:90px;">Active</th>
                          <th style="width:120px;">Order</th>
                          <th style="width:60px;"></th>
                        </tr>
                      </thead>
                      <tbody data-banks-body>
                        <% (method.methodBanks || []).forEach((bank, idx) => { %>
                          <tr data-bank-row>
                            <td>
                              <div class="bank-code-cell">
                                <input
                                  class="input bank-code-input"
                                  name="banks[<%= idx %>][code]"
                                  value="<%= bank.code %>"
                                  placeholder="BCA"
                                  list="idr-v4-bank-codes"
                                  style="text-transform:uppercase;"
                                />
                                <div class="muted bank-code-warning">Unknown bank code</div>
                              </div>
                            </td>
                            <td>
                              <input
                                class="input"
                                name="banks[<%= idx %>][label]"
                                value="<%= bank.label || '' %>"
                                placeholder="Optional label"
                              />
                            </td>
                            <td style="text-align:center;">
                              <input type="checkbox" name="banks[<%= idx %>][active]" <%= bank.active ? 'checked' : '' %> />
                            </td>
                            <td>
                              <input type="hidden" name="banks[<%= idx %>][sort]" value="<%= bank.sort || (idx + 1) %>" data-bank-sort />
                              <div class="bank-order">
                                <button class="btn small" type="button" data-bank-up>↑</button>
                                <button class="btn small" type="button" data-bank-down>↓</button>
                              </div>
                            </td>
                            <td style="text-align:center;">
                              <button class="btn small btn-outline" type="button" data-bank-remove>✕</button>
                            </td>
                          </tr>
                        <% }) %>
                      </tbody>
                    </table>
                  </div>

                  <div class="banks-controls">
                    <button type="button" class="btn small" data-bank-add>+ Add bank</button>
                    <div class="banks-error muted" aria-live="polite"></div>
                  </div>

                  <div class="modal__actions">
                    <button class="btn primary" type="submit">Save banks</button>
                  </div>
                </form>
              </div>
            </div>
          <% } %>
        <% }) %>
      </div>
    <% } %>
  </div>
</div>

<datalist id="idr-v4-bank-codes">
  <% (idrV4BankCodes || []).forEach((code) => { %>
    <option value="<%= code %>"></option>
  <% }) %>
</datalist>

<style>
  .methods-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 16px;
    margin-top: 16px;
  }
  .method-card {
    border: 1px solid #e6e6e6;
    border-radius: 12px;
    padding: 16px;
    background: #fff;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  .method-card__header {
    display: flex;
    justify-content: space-between;
    gap: 12px;
    align-items: flex-start;
  }
  .method-card__title {
    flex: 1;
  }
  .method-name {
    font-size: 18px;
    font-weight: 600;
  }
  .method-meta {
    margin-top: 6px;
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
    font-size: 12px;
    color: #666;
  }
  .pill {
    padding: 2px 8px;
    border-radius: 999px;
    background: #f0f4ff;
    color: #3b5bcc;
    font-weight: 600;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }
  .pill--subtle {
    background: #f6f6f6;
    color: #4b4b4b;
  }
  .toggle {
    display: flex;
    gap: 6px;
    align-items: center;
    font-size: 12px;
    color: #444;
  }
  .method-card__badges {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }
  .badge {
    background: #f7f7f7;
    border-radius: 8px;
    padding: 6px 10px;
    font-size: 12px;
    color: #333;
  }
  .method-card__actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  .btn-outline {
    border: 1px solid #d0d0d0;
    background: #fff;
  }
  .modal {
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 50;
  }
  .modal.is-visible {
    display: flex;
  }
  .modal__backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.4);
  }
  .modal__content {
    position: relative;
    background: #fff;
    border-radius: 12px;
    padding: 20px;
    width: min(900px, 92vw);
    max-height: 90vh;
    overflow: auto;
  }
  .modal__header {
    display: flex;
    justify-content: space-between;
    gap: 12px;
    align-items: flex-start;
    margin-bottom: 16px;
  }
  .limits-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 12px;
  }
  .limits-advanced {
    margin-top: 16px;
    padding-top: 8px;
    border-top: 1px solid #eee;
  }
  .limits-error {
    color: #b00020;
    font-size: 12px;
    margin-top: 8px;
    min-height: 16px;
  }
  .modal__actions {
    margin-top: 16px;
    display: flex;
    justify-content: flex-end;
  }
  .banks-table .table {
    width: 100%;
    border-collapse: collapse;
  }
  .bank-code-cell {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  .bank-code-warning {
    font-size: 11px;
    color: #b25;
    display: none;
  }
  .bank-order {
    display: flex;
    gap: 4px;
    justify-content: center;
  }
  .banks-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 12px;
    gap: 12px;
  }
  .banks-error {
    color: #b00020;
    font-size: 12px;
    min-height: 16px;
  }
  .input-with-suffix { position:relative; }
  .input-with-suffix .suffix {
    position:absolute; right:8px; top:50%; transform:translateY(-50%);
    font-size:12px; color:#666;
  }
  .input-with-suffix .input { padding-right:56px; }
</style>

<script>
  (function () {
    const idrMin = 10000;
    const idrMax = 100000000;

    function openModal(modal) {
      if (!modal) return;
      modal.classList.add('is-visible');
    }

    function closeModal(modal) {
      if (!modal) return;
      modal.classList.remove('is-visible');
    }

    document.querySelectorAll('[data-modal-open]').forEach((btn) => {
      btn.addEventListener('click', () => {
        const targetId = btn.getAttribute('data-modal-open');
        openModal(document.getElementById(targetId));
      });
    });

    document.querySelectorAll('[data-modal-close]').forEach((btn) => {
      btn.addEventListener('click', () => {
        const targetId = btn.getAttribute('data-modal-close');
        closeModal(document.getElementById(targetId));
      });
    });

    document.querySelectorAll('[data-modal]').forEach((modal) => {
      modal.addEventListener('click', (event) => {
        if (event.target === modal) {
          closeModal(modal);
        }
      });
    });

    document.querySelectorAll('[data-limits-form]').forEach((form) => {
      form.addEventListener('submit', (event) => {
        const isIdr = form.getAttribute('data-idr') === 'true';
        const errorEl = form.querySelector('.limits-error');
        if (errorEl) errorEl.textContent = '';
        if (!isIdr) return;

        const fields = ['minDeposit', 'maxDeposit', 'minWithdrawal', 'maxWithdrawal'];
        const values = {};
        let hasError = false;

        fields.forEach((name) => {
          const input = form.querySelector(`[name="${name}"]`);
          if (!input) return;
          const raw = String(input.value || '').replace(/,/g, '').trim();
          if (!raw) return;
          const num = Number(raw);
          if (!Number.isFinite(num)) return;
          values[name] = num;
          if (num < idrMin || num > idrMax) {
            hasError = true;
          }
        });

        if (values.minDeposit && values.maxDeposit && values.minDeposit > values.maxDeposit) {
          hasError = true;
        }
        if (values.minWithdrawal && values.maxWithdrawal && values.minWithdrawal > values.maxWithdrawal) {
          hasError = true;
        }

        if (hasError) {
          event.preventDefault();
          if (errorEl) {
            errorEl.textContent = 'For IDR, limits must be between 10,000 and 100,000,000, and min cannot exceed max.';
          }
        }
      });
    });

    const knownCodes = new Set(<%- JSON.stringify(idrV4BankCodes || []) %>);

    function updateSortInputs(body) {
      const rows = Array.from(body.querySelectorAll('[data-bank-row]'));
      rows.forEach((row, idx) => {
        const sortInput = row.querySelector('[data-bank-sort]');
        if (sortInput) sortInput.value = String(idx + 1);
      });
    }

    function refreshWarnings(row) {
      const codeInput = row.querySelector('.bank-code-input');
      const warning = row.querySelector('.bank-code-warning');
      if (!codeInput || !warning) return;
      const value = String(codeInput.value || '').trim().toUpperCase();
      if (!value || knownCodes.has(value)) {
        warning.style.display = 'none';
      } else {
        warning.style.display = '';
      }
    }

    document.querySelectorAll('[data-banks-form]').forEach((form) => {
      const body = form.querySelector('[data-banks-body]');
      const errorEl = form.querySelector('.banks-error');
      const addBtn = form.querySelector('[data-bank-add]');
      let nextIndex = body ? body.querySelectorAll('[data-bank-row]').length : 0;

      const attachRowHandlers = (row) => {
        const codeInput = row.querySelector('.bank-code-input');
        if (codeInput) {
          codeInput.addEventListener('input', () => {
            codeInput.value = String(codeInput.value || '').toUpperCase();
            refreshWarnings(row);
          });
          refreshWarnings(row);
        }

        const upBtn = row.querySelector('[data-bank-up]');
        const downBtn = row.querySelector('[data-bank-down]');
        const removeBtn = row.querySelector('[data-bank-remove]');
        upBtn?.addEventListener('click', () => {
          const prev = row.previousElementSibling;
          if (prev) prev.before(row);
          if (body) updateSortInputs(body);
        });
        downBtn?.addEventListener('click', () => {
          const next = row.nextElementSibling;
          if (next) next.after(row);
          if (body) updateSortInputs(body);
        });
        removeBtn?.addEventListener('click', () => {
          row.remove();
          if (body) updateSortInputs(body);
        });
      };

      if (body) {
        body.querySelectorAll('[data-bank-row]').forEach((row) => attachRowHandlers(row));
      }

      addBtn?.addEventListener('click', () => {
        if (!body) return;
        const idx = nextIndex++;
        const row = document.createElement('tr');
        row.setAttribute('data-bank-row', '');
        row.innerHTML = `
          <td>
            <div class="bank-code-cell">
              <input class="input bank-code-input" name="banks[${idx}][code]" placeholder="BCA" list="idr-v4-bank-codes" style="text-transform:uppercase;" />
              <div class="muted bank-code-warning">Unknown bank code</div>
            </div>
          </td>
          <td><input class="input" name="banks[${idx}][label]" placeholder="Optional label" /></td>
          <td style="text-align:center;"><input type="checkbox" name="banks[${idx}][active]" checked /></td>
          <td>
            <input type="hidden" name="banks[${idx}][sort]" value="${idx + 1}" data-bank-sort />
            <div class="bank-order">
              <button class="btn small" type="button" data-bank-up>↑</button>
              <button class="btn small" type="button" data-bank-down>↓</button>
            </div>
          </td>
          <td style="text-align:center;"><button class="btn small btn-outline" type="button" data-bank-remove>✕</button></td>
        `;
        body.appendChild(row);
        attachRowHandlers(row);
        updateSortInputs(body);
      });

      form.addEventListener('submit', (event) => {
        if (errorEl) errorEl.textContent = '';
        const rows = Array.from(form.querySelectorAll('[data-bank-row]'));
        const seen = new Set();
        let hasError = false;
        rows.forEach((row) => {
          const input = row.querySelector('.bank-code-input');
          const code = String(input?.value || '').trim().toUpperCase();
          if (!code) {
            hasError = true;
            return;
          }
          if (seen.has(code)) {
            hasError = true;
          }
          seen.add(code);
        });

        if (hasError) {
          event.preventDefault();
          if (errorEl) {
            errorEl.textContent = 'Each row needs a bank code and codes must be unique.';
          }
        }
      });
    });
  })();
</script>
