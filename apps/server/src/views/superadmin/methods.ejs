<% layout('superadmin/layout') -%>

<div class="page methods-page">
  <div class="page__header">
    <div>
      <h1>Methods</h1>
      <p class="muted">Manage payment methods, assignments, and usage.</p>
    </div>
  </div>

  <div class="card methods-card">
    <form method="post" action="/superadmin/methods" class="methods-add" data-methods-form="create">
      <div class="form-field">
        <label for="method-code">Code</label>
        <input id="method-code" class="input" required name="code" placeholder="OSKO" style="text-transform:uppercase;" />
      </div>
      <div class="form-field">
        <label for="method-name">Name</label>
        <input id="method-name" class="input" required name="name" placeholder="Osko" />
      </div>
      <div class="form-field form-field--inline">
        <label for="method-enabled">Enabled</label>
        <input id="method-enabled" type="checkbox" name="enabled" checked />
      </div>
      <div class="form-field methods-add__actions">
        <button class="btn primary" type="submit">Add method</button>
      </div>
    </form>

    <% if (!methods.length) { %>
      <p class="muted" style="margin: 12px 0;">No methods available yet.</p>
    <% } else { %>
      <div class="table-wrap">
        <table class="table methods-table">
          <thead>
            <tr>
              <th>Method</th>
              <th>Code</th>
              <th>Enabled</th>
              <th>Merchants</th>
              <th>Deposits</th>
              <th>Withdrawals</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% methods.forEach((method) => { const stat = stats[method.id] || { merchants: 0, deposits: 0, withdrawals: 0 }; const formId = `method-form-${method.id}`; %>
              <form id="<%= formId %>" method="post" action="/superadmin/methods/<%= method.id %>" data-methods-form="row"></form>
              <tr>
                <td>
                  <input class="input" form="<%= formId %>" name="name" value="<%= method.name %>" />
                </td>
                <td class="mono"><%= method.code %></td>
                <td class="enabled-cell">
                  <input form="<%= formId %>" type="checkbox" name="enabled" <%= method.enabled ? 'checked' : '' %> />
                </td>
                <td class="number-cell"><%= stat.merchants %></td>
                <td class="number-cell"><%= stat.deposits %></td>
                <td class="number-cell"><%= stat.withdrawals %></td>
                <td class="actions-cell">
                  <button class="btn small" type="submit" form="<%= formId %>">Save</button>
                  <a class="btn small" href="/superadmin/methods/<%= method.id %>/merchants">Assign merchants</a>
                </td>
              </tr>

              <!-- Per-bank limits for this method -->
              <tr>
                <td colspan="7" style="background:#fafafa; padding: 12px 16px;">
                  <% if ((method.banks || []).length === 0) { %>
                    <div class="muted" style="font-size: 12px;">No banks configured for this method yet.</div>
                  <% } else { %>
                    <div class="muted" style="font-size: 12px; margin-bottom: 6px;">
                      Per-bank limits (amounts in currency units; leave blank to use defaults):
                    </div>
                    <div class="table-wrap" style="margin:0;">
                      <table class="table" style="margin:0;">
                        <thead>
                          <tr>
                            <th style="width:28%;">Bank</th>
                            <th style="width:8%;">Currency</th>
                            <th>Min Deposit</th>
                            <th>Max Deposit</th>
                            <th>Min Withdrawal</th>
                            <th>Max Withdrawal</th>
                          </tr>
                        </thead>
                        <tbody>
                          <% method.banks.forEach((b) => { 
                            const label = b.label || (b.bankName + ' • ' + String(b.accountNo || '').slice(-4));
                            function centsToUnits(v) { return (typeof v === 'number' && !Number.isNaN(v)) ? (v / 100).toFixed(2) : '' }
                          %>
                            <tr>
                              <td>
                                <div class="mono" title="<%= b.id %>"><%= label %></div>
                                <div class="muted" style="font-size:11px;">
                                  <%= b.merchantName ? (b.merchantName + ' • ') : '' %><%= b.active ? 'Active' : 'Inactive' %>
                                </div>
                              </td>
                              <td class="mono"><%= b.currency %></td>
                              <td>
                                <div class="input-with-suffix">
                                  <input
                                    form="<%= formId %>"
                                    class="input"
                                    inputmode="decimal"
                                    placeholder="0.00"
                                    name="banks[<%= b.id %>][minDeposit]"
                                    value="<%= centsToUnits(b.minDepositCents) %>"
                                  />
                                  <span class="suffix mono"><%= b.currency %></span>
                                </div>
                              </td>
                              <td>
                                <div class="input-with-suffix">
                                  <input
                                    form="<%= formId %>"
                                    class="input"
                                    inputmode="decimal"
                                    placeholder="0.00"
                                    name="banks[<%= b.id %>][maxDeposit]"
                                    value="<%= centsToUnits(b.maxDepositCents) %>"
                                  />
                                  <span class="suffix mono"><%= b.currency %></span>
                                </div>
                              </td>
                              <td>
                                <div class="input-with-suffix">
                                  <input
                                    form="<%= formId %>"
                                    class="input"
                                    inputmode="decimal"
                                    placeholder="0.00"
                                    name="banks[<%= b.id %>][minWithdrawal]"
                                    value="<%= centsToUnits(b.minWithdrawalCents) %>"
                                  />
                                  <span class="suffix mono"><%= b.currency %></span>
                                </div>
                              </td>
                              <td>
                                <div class="input-with-suffix">
                                  <input
                                    form="<%= formId %>"
                                    class="input"
                                    inputmode="decimal"
                                    placeholder="0.00"
                                    name="banks[<%= b.id %>][maxWithdrawal]"
                                    value="<%= centsToUnits(b.maxWithdrawalCents) %>"
                                  />
                                  <span class="suffix mono"><%= b.currency %></span>
                                </div>
                              </td>
                            </tr>
                          <% }) %>
                        </tbody>
                      </table>
                    </div>
                  <% } %>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    <% } %>
  </div>
</div>

<style>
  .input-with-suffix { position:relative; }
  .input-with-suffix .suffix {
    position:absolute; right:8px; top:50%; transform:translateY(-50%);
    font-size:12px; color:#666;
  }
  .input-with-suffix .input { padding-right:56px; }
</style>