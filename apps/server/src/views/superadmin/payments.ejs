<% layout('superadmin/layout') -%>

<%
  // Helpers for qs/paging
  function toPairs(obj){ return Object.entries(obj||{}).map(function([k,v]){ if(Array.isArray(v))v=v[0]; if(v==null)v=''; return [k,String(v)] }); }
  function qsString(obj){ return new URLSearchParams(toPairs(obj)).toString(); }
  function pageHref(base, obj, p){ var usp=new URLSearchParams(toPairs(obj)); usp.set('page', String(p)); return base + '?' + usp.toString(); }
  function formatExtraValue(v){
    if (v === null || typeof v === 'undefined') return '-';
    if (Array.isArray(v)) {
      var filtered = v.map(function(item){ return item == null ? '' : String(item); }).filter(function(str){ return str.trim() !== ''; });
      return filtered.length ? filtered.join(', ') : '-';
    }
    if (typeof v === 'object') {
      try {
        var json = JSON.stringify(v);
        return json && json !== '{}' ? json : '-';
      } catch (err) {
        return '-';
      }
    }
    var str = String(v);
    return str.trim() === '' ? '-' : str;
  }

  var basePath = (type === 'DEPOSIT' ? '/superadmin/deposits' : '/superadmin/withdrawals');
  var qs = qsString(query || {});
%>

<style>
  /* Compact panel at top with tabs + export buttons */
  .panel.compact { padding: 10px 12px; display:flex; align-items:center; justify-content:space-between; gap:12px }
  .pay-tabs { display:flex; gap:6px; align-items:center }
  .pay-tabs .tab { padding: 6px 10px; border:1px solid var(--border); border-radius:10px; background:var(--panel); text-decoration:none; }
  .pay-tabs .tab.active { background: var(--fore); color: var(--back); }

  /* FILTERS — 4 rows × 3 columns on desktop; uniform control widths */
  .filters {
    display: grid;
    gap: 10px;
    align-items: center;
    grid-template-columns: repeat(3, minmax(240px, 1fr));  /* desktop: 3 columns */
  }
  @media (max-width: 1100px) {
    .filters { grid-template-columns: repeat(2, minmax(220px, 1fr)); }
  }
  @media (max-width: 700px) {
    .filters { grid-template-columns: 1fr; }
  }
  .filters > * { min-width: 0; }
  .filters .input,
  .filters select { height: 36px; width: 100%; box-sizing: border-box; }

  .filters .actions { grid-column: 1 / -1; display: flex; justify-content: flex-end; gap: 8px; }
  .filters .actions .btn { height: 36px; padding: 0 14px; }

  /* Column settings (collapsible) */
  .cols { display:flex; align-items:center; gap:12px; flex-wrap:wrap; margin:10px 0 12px }
  .cols summary { list-style:none; cursor:pointer; display:flex; align-items:baseline; gap:10px; padding:6px 0 }
  .cols summary::-webkit-details-marker{ display:none }
  .cols .muted{ opacity:.7 }
  .cols .links a{ margin-left:8px; text-decoration:underline; cursor:pointer }
  .cols .grid { display:grid; grid-template-columns: repeat(6, auto); gap:8px 16px }
  .chk{ display:inline-flex; align-items:center; gap:8px; user-select:none }
  .chk input[type="checkbox"]{ width:16px; height:16px }

  .table-wrap { overflow:auto }
  .mini { font-size:12px; opacity:.75 }
  .pill { padding:2px 6px; border:1px solid var(--border); border-radius:999px }
  .kvs { display:grid; grid-template-columns: 90px 1fr; gap:4px; font-size:12px; opacity:.9 }
  .nowrap { white-space:nowrap }
  .receipts-cell { min-width:220px; }
  .receipt-list { display:flex; flex-direction:column; gap:6px; margin-bottom:8px; }
  .receipt-item { display:flex; align-items:center; gap:6px; }
  .receipt-item form { margin:0; }
  .receipt-link { color:var(--brand); text-decoration:none; font-weight:600; }
  .receipt-link:hover { text-decoration:underline; }
  .receipt-remove { border:none; background:transparent; color:var(--ink-dim); cursor:pointer; font-size:16px; line-height:1; padding:0 4px; }
  .receipt-remove:hover { color:var(--danger, #ef4444); }
  .receipt-upload { display:flex; align-items:center; gap:8px; margin:0; }
  .receipt-upload-input { display:none; }
  .toast.toast-top-right { top:16px; right:16px; bottom:auto; left:auto; }
</style>

<!-- Top bar: tabs + exports -->
<div class="panel compact">
  <nav class="pay-tabs">
    <a class="tab <%= type==='DEPOSIT' ? 'active' : '' %>" href="/superadmin/deposits">Deposits</a>
    <a class="tab <%= type==='WITHDRAWAL' ? 'active' : '' %>" href="/superadmin/withdrawals">Withdrawals</a>
  </nav>
  <div class="row" style="gap:8px">
    <a class="btn" href="<%= (type==='DEPOSIT'?'/superadmin/deposits/export.csv':'/superadmin/withdrawals/export.csv') + (qs ? ('?'+qs) : '') %>">Export CSV</a>
    <a class="btn" href="<%= (type==='DEPOSIT'?'/superadmin/deposits/export.xlsx':'/superadmin/withdrawals/export.xlsx') + (qs ? ('?'+qs) : '') %>">Export XLSX</a>
  </div>
</div>

<!-- Filters (12 cells: 4 rows × 3 cols on desktop) -->
<form class="card filters" method="GET" action="<%= basePath %>">
  <!-- Row 1 -->
  <input class="input" name="q" placeholder="Search (ref, merchant, email, phone)" value="<%= query.q || '' %>"/>
  <input class="input" name="id" placeholder="Payment ID" value="<%= query.id || '' %>"/>
  <input class="input" name="merchantId" placeholder="Merchant ID" value="<%= query.merchantId || '' %>"/>

  <!-- Row 2 -->
  <input class="input" name="currency" placeholder="Currency" value="<%= query.currency || '' %>"/>
  <select class="input" name="status">
    <option value="">Any status</option>
    <% ["PENDING","SUBMITTED","APPROVED","REJECTED"].forEach(function(s){ %>
      <option value="<%= s %>" <%= (String(query.status||'').toUpperCase()===s ? 'selected' : '') %>><%= s %></option>
    <% }) %>
  </select>
  <input class="input" type="date" name="from" value="<%= query.from || '' %>"/>

  <!-- Row 3 -->
  <input class="input" type="date" name="to" value="<%= query.to || '' %>"/>
  <select class="input" name="dateField">
    <option value="createdAt" <%= (query.dateField||'')==='createdAt' ? 'selected' : '' %>>By created</option>
    <option value="updatedAt" <%= (query.dateField||'')==='updatedAt' ? 'selected' : '' %>>By updated</option>
  </select>
  <select class="input" name="sort">
    <% var sorts = ['createdAt:desc','createdAt:asc','processedAt:desc','processedAt:asc','amountCents:desc','amountCents:asc','status:asc','status:desc','currency:asc','currency:desc','referenceCode:asc','referenceCode:desc']; %>
    <% sorts.forEach(function(s){ %>
      <option value="<%= s %>" <%= (query.sort||'')===s ? 'selected' : '' %>><%= s %></option>
    <% }) %>
  </select>

  <!-- Row 4: replaced Page/Per page with Has receipt + amount range -->
  <select class="input" name="hasReceipt">
    <option value="">Receipt: Any</option>
    <option value="yes" <%= (query.hasReceipt||'')==='yes' ? 'selected' : '' %>>Receipt: Yes</option>
    <option value="no"  <%= (query.hasReceipt||'')==='no'  ? 'selected' : '' %>>Receipt: No</option>
  </select>
  <input class="input" type="number" step="1" name="amountMin" placeholder="Min cents" value="<%= query.amountMin || '' %>"/>
  <input class="input" type="number" step="1" name="amountMax" placeholder="Max cents" value="<%= query.amountMax || '' %>"/>

  <!-- Apply (full-width row) -->
  <div class="actions">
    <button class="btn primary">Apply</button>
  </div>
</form>

<!-- Column settings (clean, collapsible) -->
<%
  const rows = [];
  const seenIds = new Set();
  (items || []).forEach(function(row){
    if (!seenIds.has(row.id)) {
      seenIds.add(row.id);
      rows.push(row);
    }
  });
  const displayCount = rows.length;
  const columnCount = type === 'DEPOSIT' ? 15 : 14;
%>

<details class="cols" data-cols>
  <summary>
    <span class="muted">Column settings</span>
    <span class="mini" data-cols-summary></span>
  </summary>

  <div class="links mini" style="margin:10px 0 6px">
    <a href="#" id="cols-all">All</a> · <a href="#" id="cols-none">None</a>
  </div>

  <div class="grid">
    <% var COLS = [
      { id: 'txnId',        label: 'Transaction ID' },
      { id: 'userId',       label: 'User ID' },
      { id: 'merchant',     label: 'Merchant' },
      { id: 'currency',     label: 'Currency' },
      { id: 'amount',       label: 'Amount' },
      { id: 'status',       label: 'Status' },
      { id: 'bank',         label: 'Bank name' },
      { id: 'created',      label: 'Date of creation' },
      { id: 'processedAt',  label: type === 'DEPOSIT' ? 'Date of deposit' : 'Date of withdrawal' },
      { id: 'processingTime', label: 'Time to process' },
      { id: 'userInfo',     label: 'User info' },
      { id: 'comment',      label: 'Comment' },
      { id: 'admin',        label: 'Admin' },
      { id: 'receipts',     label: 'Receipts' },
      { id: 'actions',      label: 'Actions' },
    ]; %>
    <% if (type !== 'DEPOSIT') { COLS = COLS.filter(function(c){ return c.id !== 'receipts'; }); } %>
    <% COLS.forEach(function(c){ %>
      <label class="chk">
        <input type="checkbox" class="col-toggle" data-col="<%= c.id %>" checked>
        <span><%= c.label %></span>
      </label>
    <% }) %>
  </div>
</details>

<div class="panel" style="margin-bottom:8px">
  <div class="mini">Showing <%= displayCount %> of <%= total %> • Page <%= page %>/<%= pages %></div>
</div>

<div class="table-wrap">
  <table class="table" data-table>
    <thead>
      <tr>
        <th data-col="txnId">TRANSACTION ID</th>
        <th data-col="userId">USER ID</th>
        <th data-col="merchant">MERCHANT</th>
        <th data-col="currency">CURRENCY</th>
        <th data-col="amount">AMOUNT</th>
        <th data-col="status">STATUS</th>
        <th data-col="bank">BANK NAME</th>
        <th data-col="created">DATE OF CREATION</th>
        <th data-col="processedAt"><%= type === 'DEPOSIT' ? 'DATE OF DEPOSIT' : 'DATE OF WITHDRAWAL' %></th>
        <th data-col="processingTime">TIME TO PROCESS</th>
        <th data-col="userInfo">USER INFO</th>
        <th data-col="comment">COMMENT</th>
        <th data-col="admin">ADMIN</th>
        <% if (type === 'DEPOSIT') { %>
        <th data-col="receipts">RECEIPTS</th>
        <% } %>
        <th data-col="actions">ACTIONS</th>
      </tr>
    </thead>
    <tbody>
      <% if (!rows.length) { %>
        <tr><td colspan="<%= columnCount %>" style="text-align:center;color:var(--ink-dim)">No data</td></tr>
      <% } %>
      <% rows.forEach(function(p){ %>
        <% const methodRaw = (p.detailsJson && p.detailsJson.method) || (p.bankAccount && p.bankAccount.method) || ''; %>
        <% const method = (methodRaw || '').toUpperCase(); %>
        <% const payer = (p.detailsJson && (p.detailsJson.payer || p.detailsJson.destination)) || {}; %>
        <% const payerBankName = payer.bankName || p.bankAccount?.bankName || null; %>
        <% const processedAt = p.processedAt || p.updatedAt || null; %>
        <% const hasProcessed = !(p.status==='PENDING' || p.status==='SUBMITTED' || !processedAt); %>
        <% const receipts = p._receipts || p.receipts || null; %>
        <% const receiptCount = (typeof p._receiptCount === 'number') ? p._receiptCount : (receipts ? receipts.length : (p.receiptFile ? 1 : 0)); %>
        <% const showBankAccount = type === 'DEPOSIT' ? true : (p.bankAccount && p.status !== 'REJECTED'); %>
        <% const extrasList = Array.isArray(p._extrasList) ? p._extrasList : []; %>
        <% const extrasLookup = (p._extrasLookup && typeof p._extrasLookup === 'object') ? p._extrasLookup : {}; %>
        <% const hasAnyExtraLabel = function(){
             var args = Array.prototype.slice.call(arguments);
             return args.some(function(label){
               var key = String(label || '').trim().toLowerCase();
               return !!(key && extrasLookup[key]);
             });
           }; %>
      %>
        <tr>
          <td data-col="txnId"><span class="mono"><%= p.referenceCode %></span></td>
          <td data-col="userId"><span class="mono"><%= p.user?.publicId || '-' %></span></td>
          <td data-col="merchant">
            <div><%= p.merchant?.name || '-' %></div>
          </td>
          <td data-col="currency"><%= p.currency %></td>
          <td data-col="amount"><%= formatAmount(p.amountCents, p.currency) %></td>
          <td data-col="status">
            <% if (p.status==='APPROVED') { %><span class="badge success">Approved</span><% } %>
            <% if (p.status==='REJECTED') { %><span class="badge danger">Rejected</span><% } %>
            <% if (p.status==='PENDING')  { %><span class="badge warn">Pending</span><% } %>
            <% if (p.status==='SUBMITTED'){ %><span class="badge">Submitted</span><% } %>
          </td>
          <td data-col="bank">
            <% if (showBankAccount && p.bankAccount) { %>
              <span class="mono"><%= p.bankAccount.publicId || '-' %></span><br>
              <%= p.bankAccount.bankName || '-' %>
            <% } else { %>
              -
            <% } %>
          </td>
          <td data-col="created"><%- renderDateTime(p.createdAt) %></td>
          <td data-col="processedAt"><%- hasProcessed ? renderDateTime(processedAt) : '-' %></td>
          <td data-col="processingTime"><%= hasProcessed ? formatDuration(p.createdAt, processedAt) : '-' %></td>
          <td data-col="userInfo" class="info-cell">
            <div class="info-block">
              <% if (type === 'DEPOSIT' && !hasAnyExtraLabel('unique reference no', 'unique reference number')) { %>
                <div class="info-line"><span class="info-label">Unique Reference No</span><span class="info-value"><%= p.uniqueReference || '-' %></span></div>
              <% } %>
              <% if (!hasAnyExtraLabel('method')) { %>
                <div class="info-line"><span class="info-label">Method</span><span class="info-value"><%= method || '-' %></span></div>
              <% } %>
              <% if (!hasAnyExtraLabel('bank name')) { %>
                <div class="info-line"><span class="info-label">Bank name</span><span class="info-value"><%= payerBankName || '-' %></span></div>
              <% } %>
              <% if (!hasAnyExtraLabel('account holder name', 'account name')) { %>
                <div class="info-line"><span class="info-label">Account holder name</span><span class="info-value"><%= payer.holderName || payer.holder || payer.accountName || payer.name || '-' %></span></div>
              <% } %>
              <% if (method === 'OSKO') { %>
                <% if (!hasAnyExtraLabel('account number')) { %>
                  <div class="info-line"><span class="info-label">Account number</span><span class="info-value"><%= payer.accountNo || payer.accountNumber || payer.account || '-' %></span></div>
                <% } %>
                <% if (!hasAnyExtraLabel('bsb', 'bsb number')) { %>
                  <div class="info-line"><span class="info-label">BSB</span><span class="info-value"><%= payer.bsb || payer.bsbNumber || '-' %></span></div>
                <% } %>
              <% } else if (method === 'PAYID') { %>
                <% if (!hasAnyExtraLabel('payid type')) { %>
                  <div class="info-line"><span class="info-label">PayID type</span><span class="info-value"><%= (payer.payIdType || payer.payidType || '') ? String(payer.payIdType || payer.payidType).toUpperCase() : '-' %></span></div>
                <% } %>
                <% if (!hasAnyExtraLabel('payid value', 'payid')) { %>
                  <div class="info-line"><span class="info-label">PayID value</span><span class="info-value"><%= payer.payIdValue || payer.payId || payer.payid || '-' %></span></div>
                <% } %>
              <% } %>
              <% if (extrasList.length) { %>
                <% extrasList.forEach(function(extra){ %>
                  <div class="info-line"><span class="info-label"><%= extra.label %></span><span class="info-value"><%= formatExtraValue(extra.value) %></span></div>
                <% }); %>
              <% } %>
            </div>
          </td>
          <td data-col="comment"><%= p.notes || p.rejectedReason || '-' %></td>
            <td data-col="admin"><%= (p.processedByAdmin && (p.processedByAdmin.displayName || p.processedByAdmin.email)) || '-' %></td>
            <% if (type === 'DEPOSIT') { %>
            <td data-col="receipts" class="receipts-cell">
              <div class="mini" style="margin-bottom:6px">Receipts: <%= receiptCount %></div>
              <div class="receipt-list">
                <% if (receipts && receipts.length) { %>
                  <% receipts.forEach(function(r, idx){ %>
                    <div class="receipt-item">
                      <a class="receipt-link" href="<%= r.path %>" target="_blank" rel="noopener noreferrer">Receipt<%= idx ? ' ' + (idx + 1) : '' %></a>
                      <form method="post" action="/superadmin/payments/<%= p.id %>/receipts/<%= r.id %>/remove" data-receipt-remove-form>
                        <button type="button" class="receipt-remove" data-receipt-remove data-receipt-label="Receipt<%= idx ? ' ' + (idx + 1) : '' %>">&times;</button>
                      </form>
                    </div>
                  <% }) %>
                <% } else if (p.receiptFile) { %>
                  <div class="receipt-item">
                    <a class="receipt-link" href="<%= p.receiptFile.path %>" target="_blank" rel="noopener noreferrer">Receipt</a>
                    <form method="post" action="/superadmin/payments/<%= p.id %>/receipt/remove" data-receipt-remove-form>
                      <button type="button" class="receipt-remove" data-receipt-remove data-receipt-label="Receipt">&times;</button>
                    </form>
                  </div>
                <% } else { %>
                  <div class="mini" style="opacity:0.75">No receipts</div>
                <% } %>
              </div>
              <form method="post" action="/superadmin/payments/<%= p.id %>/receipt" enctype="multipart/form-data" class="receipt-upload" data-receipt-upload-form>
                <input class="receipt-upload-input" type="file" name="receipt" accept="image/*,application/pdf" required data-receipt-input>
                <button class="btn small" type="button" data-receipt-trigger><%= (receiptCount>0) ? 'Add receipt' : 'Upload receipt' %></button>
              </form>
            </td>
            <% } %>
          <td data-col="actions" class="actions">
            <div class="column" style="gap:10px">
              <form method="post" action="/superadmin/payments/<%= p.id %>/status" class="row" style="gap:6px; flex-wrap:wrap">
                <select name="toStatus" class="input">
                  <% ['APPROVED','REJECTED','PENDING','SUBMITTED'].forEach(function(s){ %>
                    <option value="<%= s %>" <%= p.status===s ? 'selected' : '' %>><%= s %></option>
                  <% }) %>
                </select>
                <input class="input" name="reason" placeholder="Reason (optional)">
                <button class="btn small" type="submit">Apply</button>
              </form>

              <form method="post" action="/superadmin/payments/<%= p.id %>/edit-amount" class="row" style="gap:6px; flex-wrap:wrap">
                <input class="input" type="number" step="0.01" name="amount" value="<%= (p.amountCents/100).toFixed(2) %>" style="width:120px">
                <input class="input" name="currency" value="<%= p.currency %>" style="width:90px">
                <input class="input" name="reason" placeholder="Reason (required) *" required>
                <button class="btn small" type="submit">Save</button>
              </form>

              <form method="post" action="/superadmin/payments/<%= p.id %>/notes" class="row" style="gap:6px; flex-wrap:wrap">
                <input class="input" name="notes" value="<%= p.notes || '' %>" placeholder="Notes" style="width:220px">
                <button class="btn small" type="submit">Save</button>
              </form>
            </div>
          </td>
        </tr>
      <% }) %>
    </tbody>
  </table>
</div>

<div class="row between" style="margin-top:10px">
  <div class="mini">Showing <%= displayCount %> of <%= total %> • Page <%= page %>/<%= pages %></div>
  <div class="row" style="gap:6px">
    <a class="btn small" href="<%= page>1 ? pageHref(basePath, query, page-1) : 'javascript:void(0)' %>">Prev</a>
    <a class="btn small" href="<%= page<pages ? pageHref(basePath, query, page+1) : 'javascript:void(0)' %>">Next</a>
  </div>
</div>

<script>
(function(){
  // Columns: persist per type
  var key = 'sa_pay_cols_' + '<%= type %>';
  var toggles = Array.prototype.slice.call(document.querySelectorAll('.col-toggle'));

  function apply(){
    var map = {};
    toggles.forEach(function(cb){ map[cb.dataset.col] = cb.checked; });
    document.querySelectorAll('[data-col]').forEach(function(el){
      var id = el.getAttribute('data-col'); el.style.display = map[id] ? '' : 'none';
    });
    // Summary text
    try {
      var on = Object.values(map).filter(Boolean).length;
      var el = document.querySelector('[data-cols-summary]');
      if (el) el.textContent = on + ' shown';
    } catch {}
    try { localStorage.setItem(key, JSON.stringify(map)); } catch {}
  }

  try {
    var saved = localStorage.getItem(key);
    if (saved) {
      var map = JSON.parse(saved);
      toggles.forEach(function(cb){ if (map.hasOwnProperty(cb.dataset.col)) cb.checked = !!map[cb.dataset.col]; });
    }
  } catch {}

  toggles.forEach(function(cb){ cb.addEventListener('change', apply); });
  document.getElementById('cols-all')?.addEventListener('click', function(e){ e.preventDefault(); toggles.forEach(function(cb){ cb.checked = true; }); apply(); });
  document.getElementById('cols-none')?.addEventListener('click', function(e){ e.preventDefault(); toggles.forEach(function(cb){ cb.checked = false; }); apply(); });
  apply();
})();
</script>