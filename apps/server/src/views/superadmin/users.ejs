<% layout('superadmin/layout') -%>

<form class="card filters" method="GET" action="">
  <div class="filters-grid grid-3">
    <div class="f-item">
      <label>Search</label>
      <input type="text" name="q" value="<%= query.q || '' %>" placeholder="Name / email / phone / user ID">
    </div>
    <div class="f-item">
      <label>Merchants</label>
      <select name="merchantId" multiple size="5">
        <% merchants.forEach(m => { %>
          <option value="<%= m.id %>" <%= selectedIds.includes(m.id) ? 'selected' : '' %>><%= m.name %> <%= m.userDirectoryEnabled ? '' : '(disabled)' %></option>
        <% }) %>
      </select>
      <small style="opacity:.7">Hold Ctrl/Cmd to select multiple merchants. Leave empty to include all.</small>
    </div>
    <div class="f-item">
      <label>&nbsp;</label>
      <button type="submit" class="btn primary">Apply</button>
    </div>
  </div>
</form>

<%
  const hasStatus = !!(statusMessage || statusError);
  const statusVariant = statusError ? 'error' : 'success';
  const flashText = statusError || statusMessage;
%>

<% if (hasStatus) { %>
  <div class="card"
       style="margin:12px 0;
              background:<%= statusVariant === 'error' ? '#fff1f2' : '#ecfdf3' %>;
              border:1px solid <%= statusVariant === 'error' ? '#fecdd3' : '#bbf7d0' %>;
              color:<%= statusVariant === 'error' ? '#b91c1c' : '#166534' %>;">
    <%= flashText %>
  </div>
<% } %>

<%- include('../partials/column-settings', {
  key: 'superadmin.columns.users',
  defaults: {
    externalId:true,
    userId:true,
    firstName:true,
    lastName:true,
    documentType:true,
    documentNumber:true,
    documentIssuingCountry:true,
    documentIssuingState:true,
    dateOfBirth:true,
    documentExpiry:true,
    gender:true,
    address:true,
    email:true,
    phone:true,
    status:true,
    clientStatus:true,
    registered:true,
    lastActivity:true,
    totalDeposits:true,
    totalWithdrawals:true,
    merchants:true,
    didit:true,
    latestSessionId:false
  },
  labelMap: {
    externalId: 'External ID',
    clientStatus: 'Client status',
    registered: 'Date registered',
    lastActivity: 'Last activity',
    totalDeposits: 'Total deposits',
    totalWithdrawals: 'Total withdrawals',
    merchants: 'Merchants',
    didit: 'Didit profile',
    latestSessionId: 'Latest session ID',
    firstName: 'First name',
    lastName: 'Last name',
    documentType: 'Document Type',
    documentNumber: 'Document Number',
    documentIssuingCountry: 'Issuing Country',
    documentIssuingState: 'Issuing State',
    dateOfBirth: 'Date of Birth',
    documentExpiry: 'Document Expiry',
    gender: 'Gender',
    address: 'Address'
  },
  columnHeading: 'CLIENT COLUMN SETTINGS'
}) %>

<% if (statusMessage) { %>
  <div class="alert success"><%= statusMessage %></div>
<% } %>
<% if (statusError) { %>
  <div class="alert error"><%= statusError %></div>
<% } %>

<div class="table-wrap">
  <% const qp = new URLSearchParams(rawQuery || {}); %>
  <div class="row" style="justify-content:flex-end; gap:8px; margin-bottom:8px;">
    <a class="btn small" href="/superadmin/export/users.csv?<%= qp.toString() %>">Export CSV</a>
    <a class="btn small" href="/superadmin/export/users.xlsx?<%= qp.toString() %>">Export XLSX</a>
    <a class="btn small" href="/superadmin/export/users.pdf?<%= qp.toString() %>">Export PDF</a>
  </div>

  <table class="table">
    <thead>
      <tr>
        <th data-col="externalId">EXTERNAL ID</th>
        <th data-col="userId">USER ID</th>
        <th data-col="firstName">FIRST NAME</th>
        <th data-col="lastName">LAST NAME</th>
        <th data-col="documentType">DOCUMENT TYPE</th>
        <th data-col="documentNumber">DOCUMENT NUMBER</th>
        <th data-col="documentIssuingCountry">ISSUING COUNTRY</th>
        <th data-col="documentIssuingState">ISSUING STATE</th>
        <th data-col="dateOfBirth">DOB</th>
        <th data-col="documentExpiry">EXPIRY</th>
        <th data-col="gender">GENDER</th>
        <th data-col="address">ADDRESS</th>
        <th data-col="email">EMAIL</th>
        <th data-col="phone">PHONE</th>
        <th data-col="status">VERIFICATION STATUS</th>
        <th data-col="clientStatus">CLIENT STATUS</th>
        <th data-col="registered">DATE REGISTERED</th>
        <th data-col="lastActivity">LAST ACTIVITY</th>
        <th data-col="totalDeposits">TOTAL DEPOSITS</th>
        <th data-col="totalWithdrawals">TOTAL WITHDRAWALS</th>
        <th data-col="merchants">MERCHANTS</th>
        <th data-col="didit">DIDIT PROFILE</th>
        <th data-col="latestSessionId">LATEST SESSION ID</th>
      </tr>
    </thead>
    <tbody>
      <% if (!table.items.length) { %>
        <tr><td colspan="25" style="text-align:center;color:var(--ink-dim)">No clients found</td></tr>
      <% } %>
      <% table.items.forEach(user => { %>
        <tr>
          <td data-col="externalId"><span class="mono"><%= user.externalId || '—' %></span></td>
          <td data-col="userId"><span class="mono"><%= user.publicId %></span></td>
          <td data-col="firstName"><%= user.firstName || '-' %></td>
          <td data-col="lastName"><%= user.lastName || '-' %></td>
          <td data-col="documentType"><%= user.documentType || '-' %></td>
          <td data-col="documentNumber"><%= user.documentNumber || '-' %></td>
          <td data-col="documentIssuingCountry"><%= user.documentIssuingCountry || '-' %></td>
          <td data-col="documentIssuingState"><%= user.documentIssuingState || '-' %></td>
          <td data-col="dateOfBirth">
            <%= user.dateOfBirth ? user.dateOfBirth.toISOString().slice(0,10) : '-' %>
          </td>
          <td data-col="documentExpiry">
            <%= user.documentExpiry ? user.documentExpiry.toISOString().slice(0,10) : '-' %>
          </td>
          <td data-col="gender"><%= user.gender || '-' %></td>
          <td data-col="address"><%= user.address || '-' %></td>
          <td data-col="email"><%= user.email || '—' %></td>
          <td data-col="phone"><%= user.phone || '—' %></td>
          <td data-col="status"><span class="badge <%= user.verificationStatus === 'Verified' ? 'success' : 'warn' %>"><%= user.verificationStatus %></span></td>
          <td data-col="clientStatus" class="info-cell">
            <% const clientStatus = (user.clientStatus || '').toUpperCase(); %>
            <div class="info-line" style="align-items:center; gap:6px;">
              <span class="badge <%= clientStatus === 'ACTIVE' ? 'success' : 'warn' %>">
                <%= clientStatus === 'BLOCKED' ? 'Blocked' : clientStatus === 'DEACTIVATED' ? 'Deactivated' : 'Active' %>
              </span>
            </div>
            <form method="post" action="/superadmin/users/status" class="inline-form" style="margin-top:6px; gap:6px; align-items:flex-start;">
              <input type="hidden" name="merchantId" value="<%= user.merchantId %>">
              <input type="hidden" name="userId" value="<%= user.id %>">
              <input type="hidden" name="returnTo" value="/superadmin/users?<%= qp.toString() %>">
              <select name="status" style="min-width:140px;">
                <option value="ACTIVE" <%= clientStatus==='ACTIVE' ? 'selected' : '' %>>Active</option>
                <option value="DEACTIVATED" <%= clientStatus==='DEACTIVATED' ? 'selected' : '' %>>Deactivated</option>
                <option value="BLOCKED" <%= clientStatus==='BLOCKED' ? 'selected' : '' %>>Blocked</option>
              </select>
              <div style="display:flex; flex-direction:column; gap:4px;">
                <input type="text" name="totp" inputmode="numeric" pattern="\d*" placeholder="2FA code" style="width:110px;">
                <small style="opacity:.7">Unblock requires 2FA when enabled.</small>
              </div>
              <button type="submit" class="btn small">Update</button>
            </form>
          </td>
          <td data-col="registered"><%- renderDateTime(user.registeredAt) %></td>
          <td data-col="lastActivity"><%- user.lastActivityAt ? renderDateTime(user.lastActivityAt) : '-' %></td>
          <td data-col="totalDeposits"><%= user.totalApprovedDeposits %></td>
          <td data-col="totalWithdrawals"><%= user.totalApprovedWithdrawals %></td>
          <td data-col="merchants" class="info-cell">
            <% if (user.merchants && user.merchants.length) { %>
              <ul class="list-unstyled">
                <% user.merchants.forEach(m => { %>
                  <li><%= m.name %></li>
                <% }) %>
              </ul>
            <% } else { %>
              -
            <% } %>
          </td>
          <td data-col="didit" class="info-cell">
              <% if (user.diditProfile) { %>
                <div class="info-block">
                  <% if (user.diditProfile.fullName) { %>
                    <div class="info-line"><span class="info-label">Name</span><span class="info-value"><%= user.diditProfile.fullName %></span></div>
                  <% } %>
                <% if (user.diditProfile.email) { %>
                  <div class="info-line"><span class="info-label">Email</span><span class="info-value"><%= user.diditProfile.email %></span></div>
                <% } %>
                <% if (user.diditProfile.phone) { %>
                  <div class="info-line"><span class="info-label">Phone</span><span class="info-value"><%= user.diditProfile.phone %></span></div>
                <% } %>
                  <% if (user.diditProfile.status) { %>
                    <div class="info-line"><span class="info-label">Status</span><span class="info-value"><%= user.diditProfile.status %></span></div>
                  <% } %>

                  <% if (user.documentType || user.documentNumber) { %>
                    <div class="info-line">
                      <span class="info-label">Document</span>
                      <span class="info-value"><%= user.documentType || '' %> <%= user.documentNumber || '' %></span>
                    </div>
                  <% } %>

                  <% if (user.documentIssuingCountry || user.documentIssuingState) { %>
                    <div class="info-line">
                      <span class="info-label">Issuing</span>
                      <span class="info-value"><%= [user.documentIssuingCountry, user.documentIssuingState].filter(Boolean).join(', ') %></span>
                    </div>
                  <% } %>

                  <% if (user.dateOfBirth) { %>
                    <div class="info-line">
                      <span class="info-label">DOB</span>
                      <span class="info-value"><%= user.dateOfBirth.toISOString().slice(0,10) %></span>
                    </div>
                  <% } %>

                  <% if (user.documentExpiry) { %>
                    <div class="info-line">
                      <span class="info-label">Expiry</span>
                      <span class="info-value"><%= user.documentExpiry.toISOString().slice(0,10) %></span>
                    </div>
                  <% } %>

                  <% if (user.gender) { %>
                    <div class="info-line"><span class="info-label">Gender</span>
                    <span class="info-value"><%= user.gender %></span></div>
                  <% } %>

                  <% if (user.address) { %>
                    <div class="info-line"><span class="info-label">Address</span>
                    <span class="info-value"><%= user.address %></span></div>
                  <% } %>
                </div>
              <% } else { %>
                -
            <% } %>
          </td>
          <td data-col="latestSessionId">
            <span class="mono"><%= user.latestSessionId || '—' %></span>
          </td>
        </tr>
      <% }) %>
    </tbody>
  </table>
</div>

<div class="pagination">
  <% const pager = new URLSearchParams(query); %>
  <% if (table.page > 1) { pager.set('page', String(table.page - 1)); %>
    <a href="?<%= pager.toString() %>">&larr; Prev</a>
  <% } else { %>
    <span>Prev</span>
  <% } %>
  <span>Showing <%= table.items.length %> / <%= table.total %> • Page <%= table.page %> / <%= table.pages %></span>
  <% if (table.page < table.pages) { pager.set('page', String(table.page + 1)); %>
    <a href="?<%= pager.toString() %>">Next &rarr;</a>
  <% } else { %>
    <span>Next</span>
  <% } %>
</div>